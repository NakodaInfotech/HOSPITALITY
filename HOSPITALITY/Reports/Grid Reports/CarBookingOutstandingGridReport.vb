
Imports BL
Imports DevExpress.XtraGrid.Views.Grid

Public Class CarBookingOutstandingGridReport

    Dim USERADD, USEREDIT, USERVIEW, USERDELETE As Boolean      'USED FOR RIGHT MANAGEMAENT
    Public FRMSTRING, WHERECLAUSE As String

    Private Sub CarBookingOutstandingGridReport_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles Me.KeyDown
        Try
            If e.KeyCode = Windows.Forms.Keys.Escape Then
                Me.Close()
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Sub fillgrid()
        Try
            Dim objclsCMST As New ClsCommonMaster
            Dim dt As DataTable


            'GET OLD YEARID
            Dim TEMPOLDYEARID As Integer = 0
            Dim TEMPYEAR As DataTable = objclsCMST.search("YEAR_ID AS YEARID", "", " YEARMASTER ", " AND YEAR_CMPID = " & CmpId & " AND YEAR_ENDDATE = '" & Format(Convert.ToDateTime(DateAdd(DateInterval.Day, -1, AccFrom.Date)).Date, "MM/dd/yyyy") & "'")

            TEMPOLDYEARID = Val(TEMPYEAR.Rows(0).Item("YEARID"))
            'LATEST CODE WITH CURRENT YEAR'S BALANCE RECTIFIED
            dt = objclsCMST.search("*", "", " (SELECT CARBOOKINGMASTER.BOOKING_SPECIALREMARKS AS SPECIALREMARKS, CARBOOKINGMASTER.BOOKING_SALEBILLINITIALS AS BILLINITIALS, CARBOOKINGMASTER.BOOKING_NO AS BILL, CARBOOKINGMASTER.BOOKING_REFNO AS REFNO, CARBOOKINGMASTER.BOOKING_DATE AS BOOKINGDATE, GUESTMASTER.GUEST_NAME AS GUESTNAME, ISNULL(GUESTMASTER.GUEST_EMAIL, '') AS EMAIL, LEDGERS.Acc_cmpname AS ACCNAME, CARBOOKINGMASTER.BOOKING_PACKAGEFROM AS [FROMDATE], CARBOOKINGMASTER.BOOKING_PACKAGETO AS [TO], CARBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURTOTAL, CARBOOKINGMASTER.BOOKING_GRANDTOTAL AS GRANDTOTAL, USERMASTER.User_Name AS USERNAME, CARBOOKINGMASTER.BOOKING_CANCELLED AS CANCELLED, CARBOOKINGMASTER.BOOKING_DISPUTE AS DISPUTED, CARBOOKINGMASTER.BOOKING_SALEBALANCE AS BALANCE, CARBOOKINGMASTER.BOOKING_BILLCHECKED AS BILLCHECKED, ISNULL(PURTAXMASTER.tax_name, '') AS PURTAXNAME, ISNULL(CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_TAXAMT, 0) AS PURTAXAMT, ISNULL(TAXMASTER.tax_name, '') AS TAXNAME, ISNULL(CARBOOKINGMASTER.BOOKING_TAX, 0) AS TAXAMT, CARBOOKINGMASTER.BOOKING_SUBTOTAL AS SUBTOTAL, CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_NETT AS PURSUBTOTAL, ISNULL(CARBOOKINGMASTER.BOOKING_CONFIRMEDBY, '') AS CONFIRMEDBY, ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0) AS STARTKMS, ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0) AS ENDKMS, ISNULL( BOOKING_TYPE,'LOCAL') AS BOOKINGTYPE, (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0)) AS TOTALKMS,  CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0))-80 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0))-40 ELSE (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0)) END) END  AS EXTRAKMS, ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0) AS STARTTIME, ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0) AS ENDTIME, (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0)) AS TOTALTIME, CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0))-8 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0))-4 ELSE (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0)) END) END  AS EXTRATIME, ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0) AS PURSTARTKMS, ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0) AS PURENDKMS, (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0)) AS PURTOTALKMS,  CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0))-80 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0))-40 ELSE  (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0)) END) END  AS PUREXTRAKMS, ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0) AS PURSTARTTIME, ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0) AS PURENDTIME, (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0)) AS PURTOTALTIME, CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0))-8 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0))-4 ELSE  (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0)) END) END  AS PUREXTRATIME, ISNULL(DRIVERMASTER.DRIVER_NAME, '') AS DRIVERNAME, ISNULL(VEHICLEMASTER.VEHICLE_NAME, '') AS VEHICLENAME, ISNULL(CARBOOKINGMASTER_DESC.BOOKING_VEHICLENO, '') AS VEHICLENO, ISNULL(CARBOOKINGMASTER.BOOKING_OTHERCHGS,0) AS OTHERCHGS, ISNULL(CARBOOKINGMASTER.BOOKING_SALEAMTREC + CARBOOKINGMASTER.BOOKING_SALEEXTRAAMT- CARBOOKINGMASTER.BOOKING_SALERETURN,0) AS AMTREC FROM DRIVERMASTER RIGHT OUTER JOIN CARBOOKINGMASTER INNER JOIN LEDGERS ON CARBOOKINGMASTER.BOOKING_LEDGERID = LEDGERS.Acc_id INNER JOIN USERMASTER ON CARBOOKINGMASTER.BOOKING_USERID = USERMASTER.User_id INNER JOIN GUESTMASTER ON CARBOOKINGMASTER.BOOKING_GUESTID = GUESTMASTER.GUEST_ID INNER JOIN CARBOOKINGMASTER_DESC ON CARBOOKINGMASTER.BOOKING_NO = CARBOOKINGMASTER_DESC.BOOKING_NO AND CARBOOKINGMASTER.BOOKING_YEARID = CARBOOKINGMASTER_DESC.BOOKING_YEARID INNER JOIN VEHICLEMASTER ON CARBOOKINGMASTER_DESC.BOOKING_VEHICLEID = VEHICLEMASTER.VEHICLE_ID ON DRIVERMASTER.DRIVER_ID = CARBOOKINGMASTER_DESC.BOOKING_DRIVERID LEFT OUTER JOIN TAXMASTER ON CARBOOKINGMASTER.BOOKING_TAXID = TAXMASTER.tax_id LEFT OUTER JOIN CARBOOKINGMASTER_PURCHASEDETAILS ON CARBOOKINGMASTER.BOOKING_NO = CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_NO AND  CARBOOKINGMASTER.BOOKING_YEARID = CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_YEARID LEFT OUTER JOIN TAXMASTER AS PURTAXMASTER ON CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_TAXID = PURTAXMASTER.tax_id WHERE CARBOOKINGMASTER.BOOKING_YEARID = " & YearId & WHERECLAUSE & " AND CARBOOKINGMASTER.BOOKING_SALEBALANCE > 0 UNION ALL (SELECT     T.SPECIALREMARKS, T.BILLINITIALS, T.BILL, T.REFNO, T.BOOKINGDATE, T.GUESTNAME, T.EMAIL, T.ACCNAME, T.FROMDATE, T.[TO], T.PURTOTAL, T.GRANDTOTAL, T.USERNAME, T.CANCELLED, T.DISPUTED, OPENINGBILL.BILL_BALANCE, T.BILLCHECKED, T.PURTAXNAME, T.PURTAXAMT, T.TAXNAME, T.TAXAMT, T.SUBTOTAL, T.PURSUBTOTAL, T.CONFIRMEDBY, T.STARTKMS, T.ENDKMS, T.BOOKINGTYPE, T.TOTALKMS, T.EXTRAKMS, T.STARTTIME, T.ENDTIME, T.TOTALTIME, T.EXTRATIME, T.PURSTARTKMS, T.PURENDKMS, T.PURTOTALKMS, T.PUREXTRAKMS, T.PURSTARTTIME, T.PURENDTIME, T.PURTOTALTIME, T.PUREXTRATIME, T.DRIVERNAME, T.VEHICLENAME, T.VEHICLENO, T.OTHERCHGS, OPENINGBILL.BILL_AMTPAIDREC FROM (SELECT CARBOOKINGMASTER.BOOKING_SPECIALREMARKS AS SPECIALREMARKS, CARBOOKINGMASTER.BOOKING_SALEBILLINITIALS AS BILLINITIALS, CARBOOKINGMASTER.BOOKING_NO AS BILL, CARBOOKINGMASTER.BOOKING_REFNO AS REFNO, CARBOOKINGMASTER.BOOKING_DATE AS BOOKINGDATE, GUESTMASTER.GUEST_NAME AS GUESTNAME, ISNULL(GUESTMASTER.GUEST_EMAIL, '') AS EMAIL, LEDGERS.Acc_cmpname AS ACCNAME, CARBOOKINGMASTER.BOOKING_PACKAGEFROM AS FROMDATE, CARBOOKINGMASTER.BOOKING_PACKAGETO AS [TO], CARBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURTOTAL, CARBOOKINGMASTER.BOOKING_GRANDTOTAL AS GRANDTOTAL, USERMASTER.User_Name AS USERNAME, CARBOOKINGMASTER.BOOKING_CANCELLED AS CANCELLED, CARBOOKINGMASTER.BOOKING_DISPUTE AS DISPUTED, CARBOOKINGMASTER.BOOKING_SALEBALANCE AS BALANCE, CARBOOKINGMASTER.BOOKING_BILLCHECKED AS BILLCHECKED, ISNULL(PURTAXMASTER.tax_name, '') AS PURTAXNAME, ISNULL(CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_TAXAMT, 0) AS PURTAXAMT, ISNULL(TAXMASTER.tax_name, '') AS TAXNAME, ISNULL(CARBOOKINGMASTER.BOOKING_TAX, 0) AS TAXAMT, CARBOOKINGMASTER.BOOKING_SUBTOTAL AS SUBTOTAL, CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_NETT AS PURSUBTOTAL, ISNULL(CARBOOKINGMASTER.BOOKING_CONFIRMEDBY, '') AS CONFIRMEDBY, ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0) AS STARTKMS, ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0) AS ENDKMS, ISNULL(CARBOOKINGMASTER.BOOKING_TYPE, 'LOCAL') AS BOOKINGTYPE, ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0) AS TOTALKMS, CASE WHEN ISNULL(BOOKING_TYPE, 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0)) - 80 ELSE (CASE WHEN BOOKING_TYPE = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0)) - 40 ELSE (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0)) END) END AS EXTRAKMS, ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0) AS STARTTIME, ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0) AS ENDTIME, ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0) AS TOTALTIME, CASE WHEN ISNULL(BOOKING_TYPE, 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0)) - 8 ELSE (CASE WHEN BOOKING_TYPE = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0)) - 4 ELSE (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0)) END) END AS EXTRATIME, ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0) AS PURSTARTKMS, ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0) AS PURENDKMS, ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0) AS PURTOTALKMS, CASE WHEN ISNULL(BOOKING_TYPE, 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0)) - 80 ELSE (CASE WHEN BOOKING_TYPE = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0)) - 40 ELSE (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0)) END) END AS PUREXTRAKMS, ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0) AS PURSTARTTIME, ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0) AS PURENDTIME, ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0) AS PURTOTALTIME, CASE WHEN ISNULL(BOOKING_TYPE, 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0)) - 8 ELSE (CASE WHEN BOOKING_TYPE = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0)) - 4 ELSE (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0) - ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0)) END) END AS PUREXTRATIME, ISNULL(DRIVERMASTER.DRIVER_NAME, '') AS DRIVERNAME, ISNULL(VEHICLEMASTER.VEHICLE_NAME, '') AS VEHICLENAME, ISNULL(CARBOOKINGMASTER_DESC.BOOKING_VEHICLENO, '') AS VEHICLENO, ISNULL(CARBOOKINGMASTER.BOOKING_OTHERCHGS, 0) AS OTHERCHGS, ISNULL(CARBOOKINGMASTER.BOOKING_SALEAMTREC + CARBOOKINGMASTER.BOOKING_SALEEXTRAAMT - CARBOOKINGMASTER.BOOKING_SALERETURN,0) AS AMTREC, CARBOOKINGMASTER.BOOKING_SALEBILLINITIALS + '/' + SUBSTRING(CAST(YEAR(YEARMASTER.year_startdate) AS VARCHAR(4)), 3, 2) + '-' + SUBSTRING(CAST(YEAR(YEARMASTER.year_enddate) AS VARCHAR(4)), 3, 2) AS NEWINITIALS, " & YearId & " AS NEWYEARID FROM DRIVERMASTER RIGHT OUTER JOIN CARBOOKINGMASTER INNER JOIN LEDGERS ON CARBOOKINGMASTER.BOOKING_LEDGERID = LEDGERS.Acc_id INNER JOIN USERMASTER ON CARBOOKINGMASTER.BOOKING_USERID = USERMASTER.User_id INNER JOIN GUESTMASTER ON CARBOOKINGMASTER.BOOKING_GUESTID = GUESTMASTER.GUEST_ID INNER JOIN CARBOOKINGMASTER_DESC ON CARBOOKINGMASTER.BOOKING_NO = CARBOOKINGMASTER_DESC.BOOKING_NO AND CARBOOKINGMASTER.BOOKING_YEARID = CARBOOKINGMASTER_DESC.BOOKING_YEARID INNER JOIN VEHICLEMASTER ON CARBOOKINGMASTER_DESC.BOOKING_VEHICLEID = VEHICLEMASTER.VEHICLE_ID ON DRIVERMASTER.DRIVER_ID = CARBOOKINGMASTER_DESC.BOOKING_DRIVERID LEFT OUTER JOIN TAXMASTER ON CARBOOKINGMASTER.BOOKING_TAXID = TAXMASTER.tax_id LEFT OUTER JOIN CARBOOKINGMASTER_PURCHASEDETAILS ON CARBOOKINGMASTER.BOOKING_NO = CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_NO AND CARBOOKINGMASTER.BOOKING_YEARID = CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_YEARID LEFT OUTER JOIN TAXMASTER AS PURTAXMASTER ON CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_TAXID = PURTAXMASTER.tax_id INNER JOIN YEARMASTER ON CARBOOKINGMASTER.BOOKING_YEARID = YEARMASTER.year_id WHERE (CARBOOKINGMASTER.BOOKING_YEARID = " & TEMPOLDYEARID & ")" & WHERECLAUSE & " AND (CARBOOKINGMASTER.BOOKING_SALEBALANCE > 0)) AS T INNER JOIN OPENINGBILL ON T.NEWYEARID = OPENINGBILL.BILL_YEARID AND T.NEWINITIALS = OPENINGBILL.BILL_INITIALS AND BILL_BALANCE > 0) ) AS FINAL ", " ORDER BY FINAL.BILL")

            'dt = objclsCMST.search("*", "", " (SELECT CARBOOKINGMASTER.BOOKING_SPECIALREMARKS AS SPECIALREMARKS, CARBOOKINGMASTER.BOOKING_SALEBILLINITIALS AS BILLINITIALS, CARBOOKINGMASTER.BOOKING_NO AS BILL, CARBOOKINGMASTER.BOOKING_REFNO AS REFNO, CARBOOKINGMASTER.BOOKING_DATE AS BOOKINGDATE, GUESTMASTER.GUEST_NAME AS GUESTNAME, ISNULL(GUESTMASTER.GUEST_EMAIL, '') AS EMAIL, LEDGERS.Acc_cmpname AS ACCNAME, CARBOOKINGMASTER.BOOKING_PACKAGEFROM AS [FROMDATE], CARBOOKINGMASTER.BOOKING_PACKAGETO AS [TO], CARBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURTOTAL, CARBOOKINGMASTER.BOOKING_GRANDTOTAL AS GRANDTOTAL, USERMASTER.User_Name AS USERNAME, CARBOOKINGMASTER.BOOKING_CANCELLED AS CANCELLED, CARBOOKINGMASTER.BOOKING_DISPUTE AS DISPUTED, CARBOOKINGMASTER.BOOKING_SALEBALANCE AS BALANCE, CARBOOKINGMASTER.BOOKING_BILLCHECKED AS BILLCHECKED, ISNULL(PURTAXMASTER.tax_name, '') AS PURTAXNAME, ISNULL(CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_TAXAMT, 0) AS PURTAXAMT, ISNULL(TAXMASTER.tax_name, '') AS TAXNAME, ISNULL(CARBOOKINGMASTER.BOOKING_TAX, 0) AS TAXAMT, CARBOOKINGMASTER.BOOKING_SUBTOTAL AS SUBTOTAL, CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_NETT AS PURSUBTOTAL, ISNULL(CARBOOKINGMASTER.BOOKING_CONFIRMEDBY, '') AS CONFIRMEDBY, ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0) AS STARTKMS, ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0) AS ENDKMS, ISNULL( BOOKING_TYPE,'LOCAL') AS BOOKINGTYPE, (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0)) AS TOTALKMS,  CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0))-80 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0))-40 ELSE (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0)) END) END  AS EXTRAKMS, ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0) AS STARTTIME, ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0) AS ENDTIME, (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0)) AS TOTALTIME, CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0))-8 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0))-4 ELSE (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0)) END) END  AS EXTRATIME, ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0) AS PURSTARTKMS, ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0) AS PURENDKMS, (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0)) AS PURTOTALKMS,  CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0))-80 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0))-40 ELSE  (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0)) END) END  AS PUREXTRAKMS, ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0) AS PURSTARTTIME, ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0) AS PURENDTIME, (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0)) AS PURTOTALTIME, CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0))-8 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0))-4 ELSE  (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0)) END) END  AS PUREXTRATIME, ISNULL(DRIVERMASTER.DRIVER_NAME, '') AS DRIVERNAME, ISNULL(VEHICLEMASTER.VEHICLE_NAME, '') AS VEHICLENAME, ISNULL(CARBOOKINGMASTER_DESC.BOOKING_VEHICLENO, '') AS VEHICLENO, ISNULL(CARBOOKINGMASTER.BOOKING_OTHERCHGS,0) AS OTHERCHGS, ISNULL(CARBOOKINGMASTER.BOOKING_SALEAMTREC + CARBOOKINGMASTER.BOOKING_SALEEXTRAAMT- CARBOOKINGMASTER.BOOKING_SALERETURN,0) AS AMTREC FROM DRIVERMASTER RIGHT OUTER JOIN CARBOOKINGMASTER INNER JOIN LEDGERS ON CARBOOKINGMASTER.BOOKING_LEDGERID = LEDGERS.Acc_id INNER JOIN USERMASTER ON CARBOOKINGMASTER.BOOKING_USERID = USERMASTER.User_id INNER JOIN GUESTMASTER ON CARBOOKINGMASTER.BOOKING_GUESTID = GUESTMASTER.GUEST_ID INNER JOIN CARBOOKINGMASTER_DESC ON CARBOOKINGMASTER.BOOKING_NO = CARBOOKINGMASTER_DESC.BOOKING_NO AND CARBOOKINGMASTER.BOOKING_YEARID = CARBOOKINGMASTER_DESC.BOOKING_YEARID INNER JOIN VEHICLEMASTER ON CARBOOKINGMASTER_DESC.BOOKING_VEHICLEID = VEHICLEMASTER.VEHICLE_ID ON DRIVERMASTER.DRIVER_ID = CARBOOKINGMASTER_DESC.BOOKING_DRIVERID LEFT OUTER JOIN TAXMASTER ON CARBOOKINGMASTER.BOOKING_TAXID = TAXMASTER.tax_id LEFT OUTER JOIN CARBOOKINGMASTER_PURCHASEDETAILS ON CARBOOKINGMASTER.BOOKING_NO = CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_NO AND  CARBOOKINGMASTER.BOOKING_YEARID = CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_YEARID LEFT OUTER JOIN TAXMASTER AS PURTAXMASTER ON CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_TAXID = PURTAXMASTER.tax_id WHERE CARBOOKINGMASTER.BOOKING_YEARID = " & YearId & WHERECLAUSE & " AND CARBOOKINGMASTER.BOOKING_SALEBALANCE > 0 UNION ALL SELECT CARBOOKINGMASTER.BOOKING_SPECIALREMARKS AS SPECIALREMARKS, CARBOOKINGMASTER.BOOKING_SALEBILLINITIALS AS BILLINITIALS, CARBOOKINGMASTER.BOOKING_NO AS BILL, CARBOOKINGMASTER.BOOKING_REFNO AS REFNO, CARBOOKINGMASTER.BOOKING_DATE AS BOOKINGDATE, GUESTMASTER.GUEST_NAME AS GUESTNAME, ISNULL(GUESTMASTER.GUEST_EMAIL, '') AS EMAIL, LEDGERS.Acc_cmpname AS ACCNAME, CARBOOKINGMASTER.BOOKING_PACKAGEFROM AS [FROMDATE], CARBOOKINGMASTER.BOOKING_PACKAGETO AS [TO], CARBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURTOTAL, CARBOOKINGMASTER.BOOKING_GRANDTOTAL AS GRANDTOTAL, USERMASTER.User_Name AS USERNAME, CARBOOKINGMASTER.BOOKING_CANCELLED AS CANCELLED, CARBOOKINGMASTER.BOOKING_DISPUTE AS DISPUTED, CARBOOKINGMASTER.BOOKING_SALEBALANCE AS BALANCE, CARBOOKINGMASTER.BOOKING_BILLCHECKED AS BILLCHECKED, ISNULL(PURTAXMASTER.tax_name, '') AS PURTAXNAME, ISNULL(CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_TAXAMT, 0) AS PURTAXAMT, ISNULL(TAXMASTER.tax_name, '') AS TAXNAME, ISNULL(CARBOOKINGMASTER.BOOKING_TAX, 0) AS TAXAMT, CARBOOKINGMASTER.BOOKING_SUBTOTAL AS SUBTOTAL, CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_NETT AS PURSUBTOTAL, ISNULL(CARBOOKINGMASTER.BOOKING_CONFIRMEDBY, '') AS CONFIRMEDBY, ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0) AS STARTKMS, ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0) AS ENDKMS, ISNULL( BOOKING_TYPE,'LOCAL') AS BOOKINGTYPE, (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0)) AS TOTALKMS,  CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0))-80 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0))-40 ELSE (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0)) END) END  AS EXTRAKMS, ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0) AS STARTTIME, ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0) AS ENDTIME, (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0)) AS TOTALTIME, CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0))-8 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0))-4 ELSE (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0)) END) END  AS EXTRATIME, ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0) AS PURSTARTKMS, ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0) AS PURENDKMS, (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0)) AS PURTOTALKMS,  CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0))-80 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0))-40 ELSE  (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0)) END) END  AS PUREXTRAKMS, ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0) AS PURSTARTTIME, ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0) AS PURENDTIME, (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0)) AS PURTOTALTIME, CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0))-8 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0))-4 ELSE  (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0)) END) END  AS PUREXTRATIME, ISNULL(DRIVERMASTER.DRIVER_NAME, '') AS DRIVERNAME, ISNULL(VEHICLEMASTER.VEHICLE_NAME, '') AS VEHICLENAME, ISNULL(CARBOOKINGMASTER_DESC.BOOKING_VEHICLENO, '') AS VEHICLENO, ISNULL(CARBOOKINGMASTER.BOOKING_OTHERCHGS,0) AS OTHERCHGS, ISNULL(CARBOOKINGMASTER.BOOKING_SALEAMTREC + CARBOOKINGMASTER.BOOKING_SALEEXTRAAMT- CARBOOKINGMASTER.BOOKING_SALERETURN,0) AS AMTREC FROM DRIVERMASTER RIGHT OUTER JOIN CARBOOKINGMASTER INNER JOIN LEDGERS ON CARBOOKINGMASTER.BOOKING_LEDGERID = LEDGERS.Acc_id INNER JOIN USERMASTER ON CARBOOKINGMASTER.BOOKING_USERID = USERMASTER.User_id INNER JOIN GUESTMASTER ON CARBOOKINGMASTER.BOOKING_GUESTID = GUESTMASTER.GUEST_ID INNER JOIN CARBOOKINGMASTER_DESC ON CARBOOKINGMASTER.BOOKING_NO = CARBOOKINGMASTER_DESC.BOOKING_NO AND CARBOOKINGMASTER.BOOKING_YEARID = CARBOOKINGMASTER_DESC.BOOKING_YEARID INNER JOIN VEHICLEMASTER ON CARBOOKINGMASTER_DESC.BOOKING_VEHICLEID = VEHICLEMASTER.VEHICLE_ID ON DRIVERMASTER.DRIVER_ID = CARBOOKINGMASTER_DESC.BOOKING_DRIVERID LEFT OUTER JOIN TAXMASTER ON CARBOOKINGMASTER.BOOKING_TAXID = TAXMASTER.tax_id LEFT OUTER JOIN CARBOOKINGMASTER_PURCHASEDETAILS ON CARBOOKINGMASTER.BOOKING_NO = CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_NO AND  CARBOOKINGMASTER.BOOKING_YEARID = CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_YEARID LEFT OUTER JOIN TAXMASTER AS PURTAXMASTER ON CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_TAXID = PURTAXMASTER.tax_id WHERE CARBOOKINGMASTER.BOOKING_YEARID = " & TEMPOLDYEARID & WHERECLAUSE & " AND CARBOOKINGMASTER.BOOKING_SALEBALANCE > 0) AS T ", " ORDER BY T.BILL")

            'ACTUAL CODE
            'dt = objclsCMST.search(" CARBOOKINGMASTER.BOOKING_SPECIALREMARKS AS SPECIALREMARKS, CARBOOKINGMASTER.BOOKING_SALEBILLINITIALS AS BILLINITIALS, CARBOOKINGMASTER.BOOKING_NO AS BILL, CARBOOKINGMASTER.BOOKING_REFNO AS REFNO, CARBOOKINGMASTER.BOOKING_DATE AS BOOKINGDATE, GUESTMASTER.GUEST_NAME AS GUESTNAME, ISNULL(GUESTMASTER.GUEST_EMAIL, '') AS EMAIL, LEDGERS.Acc_cmpname AS ACCNAME, CARBOOKINGMASTER.BOOKING_PACKAGEFROM AS [FROMDATE], CARBOOKINGMASTER.BOOKING_PACKAGETO AS [TO], CARBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURTOTAL, CARBOOKINGMASTER.BOOKING_GRANDTOTAL AS GRANDTOTAL, USERMASTER.User_Name AS USERNAME, CARBOOKINGMASTER.BOOKING_CANCELLED AS CANCELLED, CARBOOKINGMASTER.BOOKING_DISPUTE AS DISPUTED, CARBOOKINGMASTER.BOOKING_SALEBALANCE AS BALANCE, CARBOOKINGMASTER.BOOKING_BILLCHECKED AS BILLCHECKED, ISNULL(PURTAXMASTER.tax_name, '') AS PURTAXNAME, ISNULL(CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_TAXAMT, 0) AS PURTAXAMT, ISNULL(TAXMASTER.tax_name, '') AS TAXNAME, ISNULL(CARBOOKINGMASTER.BOOKING_TAX, 0) AS TAXAMT, CARBOOKINGMASTER.BOOKING_SUBTOTAL AS SUBTOTAL, CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_NETT AS PURSUBTOTAL, ISNULL(CARBOOKINGMASTER.BOOKING_CONFIRMEDBY, '') AS CONFIRMEDBY, ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0) AS STARTKMS, ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0) AS ENDKMS, ISNULL( BOOKING_TYPE,'LOCAL') AS BOOKINGTYPE, (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0)) AS TOTALKMS,  CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0))-80 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0))-40 ELSE (ISNULL(CARBOOKINGMASTER.BOOKING_ENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTKMS, 0)) END) END  AS EXTRAKMS, ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0) AS STARTTIME, ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0) AS ENDTIME, (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0)) AS TOTALTIME, CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0))-8 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0))-4 ELSE (ISNULL(CARBOOKINGMASTER.BOOKING_ENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_STARTTIME, 0)) END) END  AS EXTRATIME, ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0) AS PURSTARTKMS, ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0) AS PURENDKMS, (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0)) AS PURTOTALKMS,  CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0))-80 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0))-40 ELSE  (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDKMS, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTKMS, 0)) END) END  AS PUREXTRAKMS, ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0) AS PURSTARTTIME, ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0) AS PURENDTIME, (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0)) AS PURTOTALTIME, CASE WHEN ISNULL(BOOKING_TYPE , 'LOCAL') = 'LOCAL' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0))-8 ELSE (CASE WHEN BOOKING_TYPE  = '4HRS 40KMS' THEN (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0))-4 ELSE  (ISNULL(CARBOOKINGMASTER.BOOKING_PURENDTIME, 0)-ISNULL(CARBOOKINGMASTER.BOOKING_PURSTARTTIME, 0)) END) END  AS PUREXTRATIME, ISNULL(DRIVERMASTER.DRIVER_NAME, '') AS DRIVERNAME, ISNULL(VEHICLEMASTER.VEHICLE_NAME, '') AS VEHICLENAME, ISNULL(CARBOOKINGMASTER_DESC.BOOKING_VEHICLENO, '') AS VEHICLENO, ISNULL(CARBOOKINGMASTER.BOOKING_OTHERCHGS,0) AS OTHERCHGS, ISNULL(CARBOOKINGMASTER.BOOKING_SALEAMTREC + CARBOOKINGMASTER.BOOKING_SALEEXTRAAMT- CARBOOKINGMASTER.BOOKING_SALERETURN,0) AS AMTREC, ISNULL(CARBOOKINGMASTER.BOOKING_SALEBALANCE,0) AS BALANCE ", "", " DRIVERMASTER RIGHT OUTER JOIN CARBOOKINGMASTER INNER JOIN LEDGERS ON CARBOOKINGMASTER.BOOKING_LEDGERID = LEDGERS.Acc_id INNER JOIN USERMASTER ON CARBOOKINGMASTER.BOOKING_USERID = USERMASTER.User_id INNER JOIN GUESTMASTER ON CARBOOKINGMASTER.BOOKING_GUESTID = GUESTMASTER.GUEST_ID INNER JOIN CARBOOKINGMASTER_DESC ON CARBOOKINGMASTER.BOOKING_NO = CARBOOKINGMASTER_DESC.BOOKING_NO AND CARBOOKINGMASTER.BOOKING_YEARID = CARBOOKINGMASTER_DESC.BOOKING_YEARID INNER JOIN VEHICLEMASTER ON CARBOOKINGMASTER_DESC.BOOKING_VEHICLEID = VEHICLEMASTER.VEHICLE_ID ON DRIVERMASTER.DRIVER_ID = CARBOOKINGMASTER_DESC.BOOKING_DRIVERID LEFT OUTER JOIN TAXMASTER ON CARBOOKINGMASTER.BOOKING_TAXID = TAXMASTER.tax_id LEFT OUTER JOIN CARBOOKINGMASTER_PURCHASEDETAILS ON CARBOOKINGMASTER.BOOKING_NO = CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_NO AND  CARBOOKINGMASTER.BOOKING_YEARID = CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_YEARID LEFT OUTER JOIN TAXMASTER AS PURTAXMASTER ON CARBOOKINGMASTER_PURCHASEDETAILS.BOOKING_TAXID = PURTAXMASTER.tax_id ", " AND CARBOOKINGMASTER.BOOKING_YEARID = " & YearId & WHERECLAUSE & " AND CARBOOKINGMASTER.BOOKING_SALEBALANCE > 0 ORDER BY CARBOOKINGMASTER.BOOKING_NO")

            
            gridbilldetails.DataSource = dt
            If dt.Rows.Count > 0 Then
                gridbill.FocusedRowHandle = gridbill.RowCount - 1
                gridbill.TopRowIndex = gridbill.RowCount - 15
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Sub showform(ByVal editval As Boolean, ByVal BOOKINGNO As Integer)
        Try
            If USEREDIT = False And USERVIEW = False Then
                MsgBox("Insufficient Rights")
                Exit Sub
            End If

            If (editval = False) Or (editval = True And gridbill.RowCount > 0) Then
                Dim OBJBOOKING As New CarBooking
                OBJBOOKING.MdiParent = MDIMain
                OBJBOOKING.edit = editval
                OBJBOOKING.TEMPBOOKINGNO = BOOKINGNO
                OBJBOOKING.Show()
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub gridbill_DoubleClick(ByVal sender As Object, ByVal e As System.EventArgs) Handles gridbill.DoubleClick
        Try
            showform(True, gridbill.GetFocusedRowCellValue("BILL"))
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub cmdcancel_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmdcancel.Click
        Me.Close()
    End Sub

    Private Sub CarBookingDetails_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Load
        Try
            Dim DTROW() As DataRow = USERRIGHTS.Select("FormName = 'CAR RENTAL'")
            USERADD = DTROW(0).Item(1)
            USEREDIT = DTROW(0).Item(2)
            USERVIEW = DTROW(0).Item(3)
            USERDELETE = DTROW(0).Item(4)
            fillgrid()
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub ExcelExport_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ExcelExport.Click
        Try
            Dim PATH As String = ""
            If FileIO.FileSystem.FileExists(PATH) = True Then FileIO.FileSystem.DeleteFile(PATH)
            PATH = Application.StartupPath & "\Outstanding Details.XLS"

            Dim opti As New DevExpress.XtraPrinting.XlsExportOptions
            opti.ShowGridLines = True

            Dim workbook As String = PATH
            If FileIO.FileSystem.FileExists(PATH) = True Then Interaction.GetObject(workbook).close(False)
            GC.Collect()

            Dim PERIOD As String = ""
            PERIOD = AccFrom & " - " & AccTo

            opti.SheetName = "Outstanding Details"
            gridbill.ExportToXls(PATH, opti)
            EXCELCMPHEADER(PATH, "Outstanding Details", gridbill.VisibleColumns.Count + gridbill.GroupCount, "", PERIOD)

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub gridbill_RowStyle(ByVal sender As Object, ByVal e As DevExpress.XtraGrid.Views.Grid.RowStyleEventArgs) Handles gridbill.RowStyle
        Try
            If e.RowHandle >= 0 Then
                Dim View As GridView = sender
                If View.GetRowCellDisplayText(e.RowHandle, View.Columns("BILLCHECKED")) = "UnChecked" Then
                    e.Appearance.Font = New System.Drawing.Font("CALIBRI", 9.0F, System.Drawing.FontStyle.Bold)
                    e.Appearance.BackColor = Color.Yellow
                End If
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub
End Class