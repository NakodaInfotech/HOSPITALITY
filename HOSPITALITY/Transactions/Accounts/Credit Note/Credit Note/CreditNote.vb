
Imports System.ComponentModel
Imports System.IO
Imports System.Net
Imports BL
Imports Newtonsoft.Json
Imports RestSharp
Imports TaxProEInvoice.API

Public Class CREDITNOTE

    Dim USERADD, USEREDIT, USERVIEW, USERDELETE As Boolean      'USED FOR RIGHT MANAGEMAENT
    Public edit As Boolean
    Dim temprefno As String
    Dim CNREGABBR, CNREGINITIAL As String
    Dim CNREGID As Integer

    Dim TYPE As String  'USED FOR FORMTYPE WHILE RETRIVING DATA FROM GETDATA FUNCTION AND PASSING IN TO SP
    Public FRMSTRING As String  ' USER FOR BOOKTYPE 
    Public TEMPCNNO As Integer
    Public BILLNO As String
    Public TEMPREGNAME As String

    Private Sub cmdexit_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmdexit.Click
        Me.Close()
    End Sub

    Private Sub cmdclear_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmdclear.Click
        clear()
        edit = False
        cmbregister.Enabled = True
        cmbregister.Focus()
    End Sub

    Sub clear()

        tstxtbillno.Clear()
        EP.Clear()
        TXTSTATECODE.Clear()
        TXTBILLNO.Enabled = True
        TXTBILLNO.Clear()
        TXTSTATECODE.Clear()
        TXTGUESTNAME.Clear()
        TXTHOTELNAME.Clear()
        CMBNAME.Text = ""
        CMBNAME.Enabled = True
        txtremarks.Clear()
        CNREGABBR = ""
        CNREGINITIAL = ""

        CNDATE.Value = Mydate
        ARRIVALDATE.Value = Mydate

        TXTTOTALSALEAMT.Text = 0.0
        TXTDISCPER.Text = 0.0
        TXTDISCRS.Text = 0.0
        TXTEXTRACHGS.Text = 0.0
        TXTSERVCHGS.Clear()
        CHKTAXSERVCHGS.CheckState = CheckState.Unchecked
        CHKMANUAL.CheckState = CheckState.Unchecked
        CHKNOGSTR1.CheckState = CheckState.Unchecked
        TXTSUBTOTAL.Text = 0.0
        cmbtax.Text = ""
        txttax.Text = 0.0
        txttax.ReadOnly = True
        txttax.Enabled = False
        cmbaddsub.SelectedIndex = 0
        CMBOTHERCHGS.Text = ""
        txtotherchg.Text = 0.0
        txtroundoff.Text = 0.0
        txtgrandtotal.Text = 0.0
        TXTDP.Text = 0.0
        'CMBHSNITEMDESC.SelectedIndex = 0
        TXTHSNCODE.Clear()
        TXTCGSTPER.Clear()
        TXTCGSTAMT.Clear()
        TXTSGSTPER.Clear()
        TXTSGSTAMT.Clear()
        TXTIGSTPER.Clear()
        TXTIGSTAMT.Clear()
        'EINVOICE
        TXTIRNNO.Clear()
        TXTACKNO.Clear()
        ACKDATE.Value = Now.Date
        PBQRCODE.Image = Nothing
        LBLEINVGENERATED.Visible = False
        getmaxno_CN()

    End Sub

    Sub TOTAL()


        TXTSUBTOTAL.Text = 0.0
        ' txttax.Text = 0.0
        If Val(TXTDISCPER.Text.Trim) > 0 Then TXTDISCRS.Text = 0.0
        txtroundoff.Text = 0.0
        txtgrandtotal.Text = 0.0



        If Val(TXTDISCPER.Text) > 0 Then
            TXTDISCRS.Text = Format((Val(TXTDISCPER.Text) * Val(TXTTOTALSALEAMT.Text)) / 100, "0.00")
        Else
            'TXTDISCRECDPER.Text = Format((Val(TXTDISCRECDRS.Text) * 100) / Val(TXTTOTALSALEAMT.Text), "0.00")
        End If



        TXTSUBTOTAL.Text = Format(Val(Val(TXTTOTALSALEAMT.Text) - Val(TXTDISCRS.Text)) + Val(TXTEXTRACHGS.Text.Trim) + Val(TXTSERVCHGS.Text.Trim), "0.00")


        Dim objclscommon As New ClsCommonMaster
        Dim dt As DataTable
        If CNDATE.Value.Date < "01/07/2017" Then
            dt = objclscommon.search("TAX_NAME,tax_tax AS TAX", "", "TAXMaster", " and TAX_NAME = '" & cmbtax.Text.Trim & "' and TAX_cmpid = " & CmpId & " and TAX_Locationid = " & Locationid & " and TAX_Yearid = " & YearId)
            If CHKTAXSERVCHGS.CheckState = CheckState.Unchecked Then
                If dt.Rows.Count > 0 Then If dt.Rows(0).Item("TAX") > 0 Then txttax.Text = Format((Val(dt.Rows(0).Item(1)) * (Val(TXTSUBTOTAL.Text))) / 100, "0.00")
            Else
                If dt.Rows.Count > 0 Then If dt.Rows(0).Item("TAX") > 0 Then txttax.Text = Format((Val(dt.Rows(0).Item(1)) * (Val(TXTSERVCHGS.Text))) / 100, "0.00")
            End If
            'THIS IS DONE COZ OF TAXSERVCHGS
            'DONE BY GULKIT
            'If TYPE = "VISABOOKING" Or TYPE = "RAILBOOKING" Then
            '    txttax.Text = Format((Val(dt.Rows(0).Item(1)) * (Val(TXTEXTRACHGS.Text))) / 100, "0.00")
            'Else
            '    If CHKTAXSERVCHGS.CheckState = CheckState.Unchecked Then txttax.Text = Format((Val(dt.Rows(0).Item(1)) * (Val(TXTSUBTOTAL.Text))) / 100, "0.00") Else txttax.Text = Format((Val(dt.Rows(0).Item(1)) * (Val(TXTSERVCHGS.Text))) / 100, "0.00")
            'End If
        Else
            If CHKMANUAL.CheckState = CheckState.Unchecked Then
                If CHKTAXSERVCHGS.CheckState = CheckState.Checked Then

                    TXTCGSTAMT.Text = Format((Val(TXTCGSTPER.Text) * Val(TXTSERVCHGS.Text)) / 100, "0.00")
                    TXTSGSTAMT.Text = Format((Val(TXTSGSTPER.Text) * Val(TXTSERVCHGS.Text)) / 100, "0.00")
                    TXTIGSTAMT.Text = Format((Val(TXTIGSTPER.Text) * Val(TXTSERVCHGS.Text)) / 100, "0.00")
                Else
                    TXTCGSTAMT.Text = Format((Val(TXTCGSTPER.Text) * Val(TXTSUBTOTAL.Text)) / 100, "0.00")
                    TXTSGSTAMT.Text = Format((Val(TXTSGSTPER.Text) * Val(TXTSUBTOTAL.Text)) / 100, "0.00")
                    TXTIGSTAMT.Text = Format((Val(TXTIGSTPER.Text) * Val(TXTSUBTOTAL.Text)) / 100, "0.00")
                End If
            End If
        End If

        If cmbaddsub.Text = "Add" Then
            txtgrandtotal.Text = Format(Val(TXTSUBTOTAL.Text) + Val(txttax.Text) + Val(TXTCGSTAMT.Text) + Val(TXTSGSTAMT.Text) + +Val(TXTIGSTAMT.Text) + Val(txtotherchg.Text), "0")
            txtroundoff.Text = Format(Val(txtgrandtotal.Text) - (Val(TXTSUBTOTAL.Text) + Val(txttax.Text) + Val(TXTCGSTAMT.Text) + Val(TXTSGSTAMT.Text) + +Val(TXTIGSTAMT.Text) + Val(txtotherchg.Text)), "0.00")
        Else
            txtgrandtotal.Text = Format((Val(TXTSUBTOTAL.Text) + Val(txttax.Text)) + Val(TXTCGSTAMT.Text) + Val(TXTSGSTAMT.Text) + +Val(TXTIGSTAMT.Text) - Val(txtotherchg.Text), "0")
            txtroundoff.Text = Format(Val(txtgrandtotal.Text) - ((Val(TXTSUBTOTAL.Text) + Val(txttax.Text)) + Val(TXTCGSTAMT.Text) + Val(TXTSGSTAMT.Text) + +Val(TXTIGSTAMT.Text) - Val(txtotherchg.Text)), "0.00")
        End If


        txtgrandtotal.Text = Format(Val(txtgrandtotal.Text), "0.00")


    End Sub

    Sub getmaxno_CN()
        Dim DTTABLE As New DataTable
        DTTABLE = getmax(" isnull(max(CN_NO),0) + 1 ", "CREDITNOTEMASTER", " AND CN_cmpid=" & CmpId & " AND CN_LOCATIONID = " & Locationid & " AND CN_YEARID = " & YearId)
        If DTTABLE.Rows.Count > 0 Then
            TXTCNNO.Text = DTTABLE.Rows(0).Item(0)
        End If
    End Sub

    Private Sub CREDITNOTEdate_Validating(ByVal sender As System.Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles CNDATE.Validating
        'If Not datecheck(CNDATE.Value) Then
        '    MsgBox("Date Not in Current Accounting Year")
        '    e.Cancel = True
        'End If
    End Sub

    Private Sub cmbregister_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbregister.Enter
        Try
            If cmbregister.Text.Trim = "" Then fillregister(cmbregister, " and register_type = 'CREDITNOTE' and REGISTER_NAME <> 'AIRLINE CREDITNOTE' ")
            Dim clscommon As New ClsCommon
            Dim dt As DataTable
            dt = clscommon.search(" register_name,register_id", "", " RegisterMaster ", " and register_default = 'True' and REGISTER_NAME <> 'AIRLINE CREDITNOTE' and register_type = 'CREDITNOTE' and register_cmpid = " & CmpId & " and register_LOCATIONid = " & Locationid & " and register_YEARid = " & YearId)
            If dt.Rows.Count > 0 Then
                cmbregister.Text = dt.Rows(0).Item(0).ToString
            End If
            getmaxno_CN()
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub cmdok_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles cmdok.Click

        Try

            EP.Clear()
            If Not errorvalid() Then
                Exit Sub
            End If

            If TXTBILLNO.Text.Trim <> "" And TYPE = Nothing Then TYPE = "HOTELBOOKING"

            Dim alParaval As New ArrayList

            alParaval.Add(cmbregister.Text.Trim)
            If TYPE = Nothing Then TYPE = ""
            alParaval.Add(TYPE)
            alParaval.Add(CNDATE.Value)

            'IF BILLNO IS NOT THERE THEN ARRIVAL DATE SAME AS CNDATE
            If TXTBILLNO.Text.Trim = "" Then
                alParaval.Add(CNDATE.Value)
            Else
                alParaval.Add(ARRIVALDATE.Value)
            End If

            alParaval.Add(TXTBILLNO.Text.Trim)
            alParaval.Add(TXTGUESTNAME.Text.Trim)
            alParaval.Add(TXTHOTELNAME.Text.Trim)
            alParaval.Add(CMBNAME.Text.Trim)
            alParaval.Add(TXTHSNCODE.Text.Trim)
            alParaval.Add(Val(TXTTOTALSALEAMT.Text.Trim))
            alParaval.Add(Val(TXTDISCPER.Text.Trim))
            alParaval.Add(Val(TXTDISCRS.Text.Trim))
            alParaval.Add(0)    'Val(TXTCOMMRECDPER.Text.Trim))
            alParaval.Add(0)    'Val(TXTCOMMRECDRS.Text.Trim))
            alParaval.Add(0)    'Val(TXTPURTDSPER.Text.Trim))
            alParaval.Add(0)    'Val(TXTPURTDSRS.Text.Trim))
            alParaval.Add(Val(TXTEXTRACHGS.Text.Trim))
            alParaval.Add(Val(TXTSERVCHGS.Text.Trim))
            alParaval.Add(CHKTAXSERVCHGS.CheckState)
            alParaval.Add(CHKMANUAL.CheckState)
            alParaval.Add(Val(TXTSUBTOTAL.Text.Trim))
            alParaval.Add(cmbtax.Text.Trim)
            alParaval.Add(Val(txttax.Text.Trim))
            alParaval.Add("")   'CMBADDTAX.Text.Trim)
            alParaval.Add(0)    'Val(TXTADDTAX.Text.Trim))

            alParaval.Add(CMBOTHERCHGS.Text.Trim)
            If cmbaddsub.Text.Trim = "Add" Then
                alParaval.Add(Val(txtotherchg.Text.Trim))
            ElseIf cmbaddsub.Text.Trim = "Sub." Then
                alParaval.Add(Val((txtotherchg.Text.Trim) * (-1)))
            Else
                alParaval.Add(0)
            End If
            alParaval.Add(Val(TXTCGSTPER.Text.Trim))
            alParaval.Add(Val(TXTCGSTAMT.Text.Trim))
            alParaval.Add(Val(TXTSGSTPER.Text.Trim))
            alParaval.Add(Val(TXTSGSTAMT.Text.Trim))
            alParaval.Add(Val(TXTIGSTPER.Text.Trim))
            alParaval.Add(Val(TXTIGSTAMT.Text.Trim))
            alParaval.Add(Val(txtroundoff.Text.Trim))
            alParaval.Add(Val(txtgrandtotal.Text.Trim))
            alParaval.Add(Val(TXTDP.Text.Trim))

            alParaval.Add(txtremarks.Text.Trim)
            alParaval.Add(CmpId)
            alParaval.Add(Locationid)
            alParaval.Add(Userid)
            alParaval.Add(YearId)
            alParaval.Add(0)

            alParaval.Add(TXTIRNNO.Text.Trim)
            alParaval.Add(TXTACKNO.Text.Trim)
            alParaval.Add(Format(ACKDATE.Value.Date, "MM/dd/yyyy"))
            If PBQRCODE.Image IsNot Nothing Then
                Dim MS As New IO.MemoryStream
                PBQRCODE.Image.Save(MS, Drawing.Imaging.ImageFormat.Png)
                alParaval.Add(MS.ToArray)
            Else
                alParaval.Add(DBNull.Value)
            End If

            If CHKNOGSTR1.Checked = True Then alParaval.Add(1) Else alParaval.Add(0)


            Dim objclsCNmaster As New ClsCreditNote()
            objclsCNmaster.alParaval = alParaval
            Dim DTTABLE As DataTable

            If edit = False Then
                If USERADD = False Then
                    MsgBox("Insufficient Rights")
                    Exit Sub
                End If
                DTTABLE = objclsCNmaster.save()
                MessageBox.Show("Details Added")
                PRINTREPORT(DTTABLE.Rows(0).Item(0))
            Else
                If USEREDIT = False Then
                    MsgBox("Insufficient Rights")
                    Exit Sub
                End If
                alParaval.Add(TEMPCNNO)
                DTTABLE = objclsCNmaster.update()
                MsgBox("Details Updated")
                PRINTREPORT(TEMPCNNO)
            End If


            If TXTBILLNO.Text.Trim <> "" And edit = False And TYPE = "HOTELBOOKING" Then
                Dim TEMPMSG As Integer = MsgBox("Wish to Create Debit Note?", MsgBoxStyle.YesNo)
                If TEMPMSG = vbYes Then

                    Dim OBJCMN As New ClsCommon
                    Dim DTNEW As DataTable

                    If TYPE = "HOTELBOOKING" Then
                        If FRMSTRING = "TRANSFER" Then
                            DTNEW = OBJCMN.search(" * ", "", " (SELECT 'HOTELBOOKING' AS TYPE, HOTELBOOKINGMASTER.BOOKING_ARRIVAL AS ARRIVAL, HOTELBOOKINGMASTER.BOOKING_PURAMTPAID AS PAIDAMT, HOTELBOOKINGMASTER.BOOKING_PURBILLINITIALS AS BILLNO, HOTELBOOKINGMASTER.BOOKING_CMPID AS CMPID, HOTELBOOKINGMASTER.BOOKING_LOCATIONID AS LOCATIONID, HOTELBOOKINGMASTER.BOOKING_YEARID AS YEARID, ISNULL(GUESTMASTER.GUEST_NAME, '') AS GUESTNAME, ISNULL(HOTELMASTER.HOTEL_NAME, '') AS HOTELNAME, ISNULL(LEDGERS.Acc_cmpname, '') AS NAME, HOTELBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURAMT, HOTELBOOKINGMASTER.BOOKING_DISCRECDPER AS DISCPER, HOTELBOOKINGMASTER.BOOKING_DISCRECDRS AS DISCRS, HOTELBOOKINGMASTER.BOOKING_COMMRECDPER AS COMMPER, HOTELBOOKINGMASTER.BOOKING_COMMRECDRS AS COMMRS, HOTELBOOKINGMASTER.BOOKING_PURTDSPER AS TDSPER, HOTELBOOKINGMASTER.BOOKING_PURTDSRS AS TDSRS, HOTELBOOKINGMASTER.BOOKING_PUREXTRACHGS AS EXTRACHGS, ISNULL(TAXMASTER.tax_name, '') AS TAXNAME, HOTELBOOKINGMASTER.BOOKING_PURTAX AS TAXAMT, ISNULL(ADDTAXMASTER.tax_name, '') AS ADDTAXNAME, HOTELBOOKINGMASTER.BOOKING_PURADDTAX AS ADDTAXAMT, ISNULL(OTHERCHGS.Acc_cmpname, '') AS OTHERCHGSNAME, HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGS AS OTHERCHGS, HOTELBOOKINGMASTER.BOOKING_PURROUNDOFF AS ROUNDOFF, HOTELBOOKINGMASTER.BOOKING_PURGRANDTOTAL AS GTOTAL, ISNULL(HOTELBOOKINGMASTER.BOOKING_DP, 0) AS DP, ISNULL(CAST(STATEMASTER.state_remark AS VARCHAR), '') AS STATECODE, ISNULL(HOTELBOOKINGMASTER.BOOKING_PUROURCOMMPER, 0) AS SERVCHGS, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURTAXSERVCHGS, 0) AS TAXSERVCHGS, ISNULL(HSNMASTER.HSN_ITEMDESC, '') AS ITEMDESC, ISNULL(HSNMASTER.HSN_CODE, '') AS HSNCODE, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURCGSTPER, 0) AS CGSTPER, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURCGSTAMT, 0) AS CGSTAMT, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURSGSTPER, 0) AS SGSTPER, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURSGSTAMT, 0) AS SGSTAMT, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURIGSTPER, 0) AS IGSTPER, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURIGSTAMT, 0) AS IGSTAMT, HOTELBOOKINGMASTER.BOOKING_PURMANUALGST AS MANUALGST FROM STATEMASTER RIGHT OUTER JOIN LEDGERS ON STATEMASTER.state_id = LEDGERS.Acc_stateid RIGHT OUTER JOIN TAXMASTER RIGHT OUTER JOIN HSNMASTER RIGHT OUTER JOIN GUESTMASTER INNER JOIN HOTELBOOKINGMASTER ON GUESTMASTER.GUEST_ID = HOTELBOOKINGMASTER.BOOKING_GUESTID AND GUESTMASTER.GUEST_CMPID = HOTELBOOKINGMASTER.BOOKING_CMPID AND GUESTMASTER.GUEST_LOCATIONID = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND GUESTMASTER.GUEST_YEARID = HOTELBOOKINGMASTER.BOOKING_YEARID INNER JOIN HOTELMASTER ON HOTELBOOKINGMASTER.BOOKING_HOTELID = HOTELMASTER.HOTEL_ID AND HOTELBOOKINGMASTER.BOOKING_CMPID = HOTELMASTER.HOTEL_CMPID AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = HOTELMASTER.HOTEL_LOCATIONID AND HOTELBOOKINGMASTER.BOOKING_YEARID = HOTELMASTER.HOTEL_YEARID ON HSNMASTER.HSN_ID = HOTELBOOKINGMASTER.BOOKING_PURHSNCODEID LEFT OUTER JOIN LEDGERS AS OTHERCHGS ON HOTELBOOKINGMASTER.BOOKING_YEARID = OTHERCHGS.Acc_yearid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = OTHERCHGS.Acc_locationid AND HOTELBOOKINGMASTER.BOOKING_CMPID = OTHERCHGS.Acc_cmpid AND HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGSID = OTHERCHGS.Acc_id LEFT OUTER JOIN TAXMASTER AS ADDTAXMASTER ON HOTELBOOKINGMASTER.BOOKING_PURADDTAXID = ADDTAXMASTER.tax_id AND HOTELBOOKINGMASTER.BOOKING_CMPID = ADDTAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = ADDTAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_YEARID = ADDTAXMASTER.tax_yearid ON TAXMASTER.tax_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND TAXMASTER.tax_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND TAXMASTER.tax_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND TAXMASTER.tax_id = HOTELBOOKINGMASTER.BOOKING_PURTAXID ON LEDGERS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND LEDGERS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND LEDGERS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND LEDGERS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PURLEDGERID ) AS T ", " AND T.BILLNO = 'TP-" & BILLNO & "' AND T.CMPID = " & CmpId & " AND T.LOCATIONID = " & Locationid & " AND T.YEARID = " & YearId)
                            'DTNEW = OBJCMN.search(" * ", "", " (SELECT 'HOTELBOOKING' AS TYPE, BOOKING_ARRIVAL AS ARRIVAL, BOOKING_PURAMTPAID AS PAIDAMT, BOOKING_PURBILLINITIALS AS BILLNO, BOOKING_CMPID AS CMPID, BOOKING_LOCATIONID AS LOCATIONID, BOOKING_YEARID AS YEARID , ISNULL(GUESTMASTER.GUEST_NAME,'') AS GUESTNAME, ISNULL(HOTELMASTER.HOTEL_NAME,'') AS HOTELNAME, ISNULL(LEDGERS.Acc_cmpname,'') AS NAME, HOTELBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURAMT, HOTELBOOKINGMASTER.BOOKING_DISCRECDPER AS DISCPER, HOTELBOOKINGMASTER.BOOKING_DISCRECDRS AS DISCRS, HOTELBOOKINGMASTER.BOOKING_COMMRECDPER AS COMMPER, HOTELBOOKINGMASTER.BOOKING_COMMRECDRS AS COMMRS, HOTELBOOKINGMASTER.BOOKING_PURTDSPER AS TDSPER, HOTELBOOKINGMASTER.BOOKING_PURTDSRS AS TDSRS, HOTELBOOKINGMASTER.BOOKING_PUREXTRACHGS AS EXTRACHGS, ISNULL(TAXMASTER.tax_name,'') AS TAXNAME, HOTELBOOKINGMASTER.BOOKING_PURTAX AS TAXAMT, ISNULL(ADDTAXMASTER.tax_name,'') AS ADDTAXNAME, HOTELBOOKINGMASTER.BOOKING_PURADDTAX AS ADDTAXAMT, ISNULL(OTHERCHGS.Acc_cmpname,'') AS OTHERCHGSNAME, HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGS AS OTHERCHGS, HOTELBOOKINGMASTER.BOOKING_PURROUNDOFF AS ROUNDOFF, HOTELBOOKINGMASTER.BOOKING_PURGRANDTOTAL AS GTOTAL, ISNULL(HOTELBOOKINGMASTER.BOOKING_DP,0) AS DP FROM LEDGERS RIGHT OUTER JOIN LEDGERS AS OTHERCHGS RIGHT OUTER JOIN GUESTMASTER INNER JOIN HOTELBOOKINGMASTER ON GUESTMASTER.GUEST_ID = HOTELBOOKINGMASTER.BOOKING_GUESTID AND GUESTMASTER.GUEST_CMPID = HOTELBOOKINGMASTER.BOOKING_CMPID AND GUESTMASTER.GUEST_LOCATIONID = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND GUESTMASTER.GUEST_YEARID = HOTELBOOKINGMASTER.BOOKING_YEARID INNER JOIN HOTELMASTER ON HOTELBOOKINGMASTER.BOOKING_HOTELID = HOTELMASTER.HOTEL_ID AND HOTELBOOKINGMASTER.BOOKING_CMPID = HOTELMASTER.HOTEL_CMPID AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = HOTELMASTER.HOTEL_LOCATIONID AND HOTELBOOKINGMASTER.BOOKING_YEARID = HOTELMASTER.HOTEL_YEARID ON OTHERCHGS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND OTHERCHGS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND OTHERCHGS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND OTHERCHGS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGSID LEFT OUTER JOIN TAXMASTER AS ADDTAXMASTER ON HOTELBOOKINGMASTER.BOOKING_PURADDTAXID = ADDTAXMASTER.tax_id AND HOTELBOOKINGMASTER.BOOKING_CMPID = ADDTAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = ADDTAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_YEARID = ADDTAXMASTER.tax_yearid LEFT OUTER JOIN TAXMASTER ON HOTELBOOKINGMASTER.BOOKING_YEARID = TAXMASTER.tax_yearid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = TAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_CMPID = TAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_PURTAXID = TAXMASTER.tax_id ON LEDGERS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND LEDGERS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND LEDGERS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND LEDGERS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PURLEDGERID ) AS T ", " AND T.BILLNO = 'TP-" & BILLNO & "' AND T.CMPID = " & CmpId & " AND T.LOCATIONID = " & Locationid & " AND T.YEARID = " & YearId)
                            'DTNEW = OBJCMN.search(" * ", "", " (SELECT BOOKING_PURBILLINITIALS AS BILLNO, BOOKING_CMPID AS CMPID, BOOKING_LOCATIONID AS LOCATIONID, BOOKING_YEARID AS YEARID , ISNULL(GUESTMASTER.GUEST_NAME,'') AS GUESTNAME, ISNULL(HOTELMASTER.HOTEL_NAME,'') AS HOTELNAME, ISNULL(LEDGERS.Acc_cmpname,'') AS NAME, HOTELBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURAMT, HOTELBOOKINGMASTER.BOOKING_DISCRECDPER AS DISCPER, HOTELBOOKINGMASTER.BOOKING_DISCRECDRS AS DISCRS, HOTELBOOKINGMASTER.BOOKING_COMMRECDPER AS COMMPER, HOTELBOOKINGMASTER.BOOKING_COMMRECDRS AS COMMRS, HOTELBOOKINGMASTER.BOOKING_PURTDSPER AS TDSPER, HOTELBOOKINGMASTER.BOOKING_PURTDSRS AS TDSRS, HOTELBOOKINGMASTER.BOOKING_PUREXTRACHGS AS EXTRACHGS, ISNULL(TAXMASTER.tax_name,'') AS TAXNAME, HOTELBOOKINGMASTER.BOOKING_PURTAX AS TAXAMT, ISNULL(ADDTAXMASTER.tax_name,'') AS ADDTAXNAME, HOTELBOOKINGMASTER.BOOKING_PURADDTAX AS ADDTAXAMT, ISNULL(OTHERCHGS.Acc_cmpname,'') AS OTHERCHGSNAME, HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGS AS OTHERCHGS, HOTELBOOKINGMASTER.BOOKING_PURROUNDOFF AS ROUNDOFF, HOTELBOOKINGMASTER.BOOKING_PURGRANDTOTAL AS GTOTAL FROM LEDGERS RIGHT OUTER JOIN LEDGERS AS OTHERCHGS RIGHT OUTER JOIN GUESTMASTER INNER JOIN HOTELBOOKINGMASTER ON GUESTMASTER.GUEST_ID = HOTELBOOKINGMASTER.BOOKING_GUESTID AND GUESTMASTER.GUEST_CMPID = HOTELBOOKINGMASTER.BOOKING_CMPID AND GUESTMASTER.GUEST_LOCATIONID = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND GUESTMASTER.GUEST_YEARID = HOTELBOOKINGMASTER.BOOKING_YEARID INNER JOIN HOTELMASTER ON HOTELBOOKINGMASTER.BOOKING_HOTELID = HOTELMASTER.HOTEL_ID AND HOTELBOOKINGMASTER.BOOKING_CMPID = HOTELMASTER.HOTEL_CMPID AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = HOTELMASTER.HOTEL_LOCATIONID AND HOTELBOOKINGMASTER.BOOKING_YEARID = HOTELMASTER.HOTEL_YEARID ON OTHERCHGS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND OTHERCHGS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND OTHERCHGS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND OTHERCHGS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGSID LEFT OUTER JOIN TAXMASTER AS ADDTAXMASTER ON HOTELBOOKINGMASTER.BOOKING_PURADDTAXID = ADDTAXMASTER.tax_id AND HOTELBOOKINGMASTER.BOOKING_CMPID = ADDTAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = ADDTAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_YEARID = ADDTAXMASTER.tax_yearid LEFT OUTER JOIN TAXMASTER ON HOTELBOOKINGMASTER.BOOKING_YEARID = TAXMASTER.tax_yearid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = TAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_CMPID = TAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_PURTAXID = TAXMASTER.tax_id ON LEDGERS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND LEDGERS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND LEDGERS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND LEDGERS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PURLEDGERID ) AS T ", " AND T.BILLNO = 'TP-" & BILLNO & "' AND T.CMPID = " & CmpId & " AND T.LOCATIONID = " & Locationid & " AND T.YEARID = " & YearId)
                        Else
                            DTNEW = OBJCMN.search(" * ", "", " (SELECT 'HOTELBOOKING' AS TYPE, HOTELBOOKINGMASTER.BOOKING_ARRIVAL AS ARRIVAL, HOTELBOOKINGMASTER.BOOKING_PURAMTPAID AS PAIDAMT, HOTELBOOKINGMASTER.BOOKING_PURBILLINITIALS AS BILLNO, HOTELBOOKINGMASTER.BOOKING_CMPID AS CMPID, HOTELBOOKINGMASTER.BOOKING_LOCATIONID AS LOCATIONID, HOTELBOOKINGMASTER.BOOKING_YEARID AS YEARID, ISNULL(GUESTMASTER.GUEST_NAME, '') AS GUESTNAME, ISNULL(HOTELMASTER.HOTEL_NAME, '') AS HOTELNAME, ISNULL(LEDGERS.Acc_cmpname, '') AS NAME, HOTELBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURAMT, HOTELBOOKINGMASTER.BOOKING_DISCRECDPER AS DISCPER, HOTELBOOKINGMASTER.BOOKING_DISCRECDRS AS DISCRS, HOTELBOOKINGMASTER.BOOKING_COMMRECDPER AS COMMPER, HOTELBOOKINGMASTER.BOOKING_COMMRECDRS AS COMMRS, HOTELBOOKINGMASTER.BOOKING_PURTDSPER AS TDSPER, HOTELBOOKINGMASTER.BOOKING_PURTDSRS AS TDSRS, HOTELBOOKINGMASTER.BOOKING_PUREXTRACHGS AS EXTRACHGS, ISNULL(TAXMASTER.tax_name, '') AS TAXNAME, HOTELBOOKINGMASTER.BOOKING_PURTAX AS TAXAMT, ISNULL(ADDTAXMASTER.tax_name, '') AS ADDTAXNAME, HOTELBOOKINGMASTER.BOOKING_PURADDTAX AS ADDTAXAMT, ISNULL(OTHERCHGS.Acc_cmpname, '') AS OTHERCHGSNAME, HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGS AS OTHERCHGS, HOTELBOOKINGMASTER.BOOKING_PURROUNDOFF AS ROUNDOFF, HOTELBOOKINGMASTER.BOOKING_PURGRANDTOTAL AS GTOTAL, ISNULL(HOTELBOOKINGMASTER.BOOKING_DP, 0) AS DP, ISNULL(CAST(STATEMASTER.state_remark AS VARCHAR), '') AS STATECODE, ISNULL(HOTELBOOKINGMASTER.BOOKING_PUROURCOMMPER, 0) AS SERVCHGS, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURTAXSERVCHGS, 0) AS TAXSERVCHGS, ISNULL(HSNMASTER.HSN_ITEMDESC, '') AS ITEMDESC,ISNULL(HSNMASTER.HSN_CODE, '') AS HSNCODE,  ISNULL(HOTELBOOKINGMASTER.BOOKING_PURCGSTPER, 0) AS CGSTPER, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURCGSTAMT, 0) AS CGSTAMT, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURSGSTPER, 0) AS SGSTPER, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURSGSTAMT, 0) AS SGSTAMT, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURIGSTPER, 0) AS IGSTPER, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURIGSTAMT, 0) AS IGSTAMT, HOTELBOOKINGMASTER.BOOKING_PURMANUALGST AS MANUALGST FROM LEDGERS LEFT OUTER JOIN STATEMASTER ON LEDGERS.Acc_stateid = STATEMASTER.state_id RIGHT OUTER JOIN LEDGERS AS OTHERCHGS RIGHT OUTER JOIN GUESTMASTER INNER JOIN HOTELBOOKINGMASTER ON GUESTMASTER.GUEST_ID = HOTELBOOKINGMASTER.BOOKING_GUESTID AND GUESTMASTER.GUEST_CMPID = HOTELBOOKINGMASTER.BOOKING_CMPID AND GUESTMASTER.GUEST_LOCATIONID = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND GUESTMASTER.GUEST_YEARID = HOTELBOOKINGMASTER.BOOKING_YEARID INNER JOIN HOTELMASTER ON HOTELBOOKINGMASTER.BOOKING_HOTELID = HOTELMASTER.HOTEL_ID AND HOTELBOOKINGMASTER.BOOKING_CMPID = HOTELMASTER.HOTEL_CMPID AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = HOTELMASTER.HOTEL_LOCATIONID AND HOTELBOOKINGMASTER.BOOKING_YEARID = HOTELMASTER.HOTEL_YEARID ON OTHERCHGS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND OTHERCHGS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND OTHERCHGS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND OTHERCHGS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGSID LEFT OUTER JOIN TAXMASTER AS ADDTAXMASTER ON HOTELBOOKINGMASTER.BOOKING_PURADDTAXID = ADDTAXMASTER.tax_id AND HOTELBOOKINGMASTER.BOOKING_CMPID = ADDTAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = ADDTAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_YEARID = ADDTAXMASTER.tax_yearid LEFT OUTER JOIN TAXMASTER ON HOTELBOOKINGMASTER.BOOKING_YEARID = TAXMASTER.tax_yearid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = TAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_CMPID = TAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_PURTAXID = TAXMASTER.tax_id ON LEDGERS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND LEDGERS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND LEDGERS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND LEDGERS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PURLEDGERID LEFT OUTER JOIN HSNMASTER ON HOTELBOOKINGMASTER.BOOKING_PURHSNCODEID = HSNMASTER.HSN_ID ) AS T ", " AND T.BILLNO = 'P-" & BILLNO & "' AND T.CMPID = " & CmpId & " AND T.LOCATIONID = " & Locationid & " AND T.YEARID = " & YearId)
                            'DTNEW = OBJCMN.search(" * ", "", " (SELECT 'HOTELBOOKING' AS TYPE, BOOKING_ARRIVAL AS ARRIVAL, BOOKING_PURAMTPAID AS PAIDAMT, BOOKING_PURBILLINITIALS AS BILLNO, BOOKING_CMPID AS CMPID, BOOKING_LOCATIONID AS LOCATIONID, BOOKING_YEARID AS YEARID , ISNULL(GUESTMASTER.GUEST_NAME,'') AS GUESTNAME, ISNULL(HOTELMASTER.HOTEL_NAME,'') AS HOTELNAME, ISNULL(LEDGERS.Acc_cmpname,'') AS NAME, HOTELBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURAMT, HOTELBOOKINGMASTER.BOOKING_DISCRECDPER AS DISCPER, HOTELBOOKINGMASTER.BOOKING_DISCRECDRS AS DISCRS, HOTELBOOKINGMASTER.BOOKING_COMMRECDPER AS COMMPER, HOTELBOOKINGMASTER.BOOKING_COMMRECDRS AS COMMRS, HOTELBOOKINGMASTER.BOOKING_PURTDSPER AS TDSPER, HOTELBOOKINGMASTER.BOOKING_PURTDSRS AS TDSRS, HOTELBOOKINGMASTER.BOOKING_PUREXTRACHGS AS EXTRACHGS, ISNULL(TAXMASTER.tax_name,'') AS TAXNAME, HOTELBOOKINGMASTER.BOOKING_PURTAX AS TAXAMT, ISNULL(ADDTAXMASTER.tax_name,'') AS ADDTAXNAME, HOTELBOOKINGMASTER.BOOKING_PURADDTAX AS ADDTAXAMT, ISNULL(OTHERCHGS.Acc_cmpname,'') AS OTHERCHGSNAME, HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGS AS OTHERCHGS, HOTELBOOKINGMASTER.BOOKING_PURROUNDOFF AS ROUNDOFF, HOTELBOOKINGMASTER.BOOKING_PURGRANDTOTAL AS GTOTAL, ISNULL(HOTELBOOKINGMASTER.BOOKING_DP,0) AS DP FROM LEDGERS RIGHT OUTER JOIN LEDGERS AS OTHERCHGS RIGHT OUTER JOIN GUESTMASTER INNER JOIN HOTELBOOKINGMASTER ON GUESTMASTER.GUEST_ID = HOTELBOOKINGMASTER.BOOKING_GUESTID AND GUESTMASTER.GUEST_CMPID = HOTELBOOKINGMASTER.BOOKING_CMPID AND GUESTMASTER.GUEST_LOCATIONID = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND GUESTMASTER.GUEST_YEARID = HOTELBOOKINGMASTER.BOOKING_YEARID INNER JOIN HOTELMASTER ON HOTELBOOKINGMASTER.BOOKING_HOTELID = HOTELMASTER.HOTEL_ID AND HOTELBOOKINGMASTER.BOOKING_CMPID = HOTELMASTER.HOTEL_CMPID AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = HOTELMASTER.HOTEL_LOCATIONID AND HOTELBOOKINGMASTER.BOOKING_YEARID = HOTELMASTER.HOTEL_YEARID ON OTHERCHGS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND OTHERCHGS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND OTHERCHGS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND OTHERCHGS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGSID LEFT OUTER JOIN TAXMASTER AS ADDTAXMASTER ON HOTELBOOKINGMASTER.BOOKING_PURADDTAXID = ADDTAXMASTER.tax_id AND HOTELBOOKINGMASTER.BOOKING_CMPID = ADDTAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = ADDTAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_YEARID = ADDTAXMASTER.tax_yearid LEFT OUTER JOIN TAXMASTER ON HOTELBOOKINGMASTER.BOOKING_YEARID = TAXMASTER.tax_yearid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = TAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_CMPID = TAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_PURTAXID = TAXMASTER.tax_id ON LEDGERS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND LEDGERS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND LEDGERS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND LEDGERS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PURLEDGERID ) AS T ", " AND T.BILLNO = 'P-" & BILLNO & "' AND T.CMPID = " & CmpId & " AND T.LOCATIONID = " & Locationid & " AND T.YEARID = " & YearId)
                            'DTNEW = OBJCMN.search(" * ", "", " (SELECT BOOKING_PURBILLINITIALS AS BILLNO, BOOKING_CMPID AS CMPID, BOOKING_LOCATIONID AS LOCATIONID, BOOKING_YEARID AS YEARID , ISNULL(GUESTMASTER.GUEST_NAME,'') AS GUESTNAME, ISNULL(HOTELMASTER.HOTEL_NAME,'') AS HOTELNAME, ISNULL(LEDGERS.Acc_cmpname,'') AS NAME, HOTELBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURAMT, HOTELBOOKINGMASTER.BOOKING_DISCRECDPER AS DISCPER, HOTELBOOKINGMASTER.BOOKING_DISCRECDRS AS DISCRS, HOTELBOOKINGMASTER.BOOKING_COMMRECDPER AS COMMPER, HOTELBOOKINGMASTER.BOOKING_COMMRECDRS AS COMMRS, HOTELBOOKINGMASTER.BOOKING_PURTDSPER AS TDSPER, HOTELBOOKINGMASTER.BOOKING_PURTDSRS AS TDSRS, HOTELBOOKINGMASTER.BOOKING_PUREXTRACHGS AS EXTRACHGS, ISNULL(TAXMASTER.tax_name,'') AS TAXNAME, HOTELBOOKINGMASTER.BOOKING_PURTAX AS TAXAMT, ISNULL(ADDTAXMASTER.tax_name,'') AS ADDTAXNAME, HOTELBOOKINGMASTER.BOOKING_PURADDTAX AS ADDTAXAMT, ISNULL(OTHERCHGS.Acc_cmpname,'') AS OTHERCHGSNAME, HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGS AS OTHERCHGS, HOTELBOOKINGMASTER.BOOKING_PURROUNDOFF AS ROUNDOFF, HOTELBOOKINGMASTER.BOOKING_PURGRANDTOTAL AS GTOTAL FROM LEDGERS RIGHT OUTER JOIN LEDGERS AS OTHERCHGS RIGHT OUTER JOIN GUESTMASTER INNER JOIN HOTELBOOKINGMASTER ON GUESTMASTER.GUEST_ID = HOTELBOOKINGMASTER.BOOKING_GUESTID AND GUESTMASTER.GUEST_CMPID = HOTELBOOKINGMASTER.BOOKING_CMPID AND GUESTMASTER.GUEST_LOCATIONID = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND GUESTMASTER.GUEST_YEARID = HOTELBOOKINGMASTER.BOOKING_YEARID INNER JOIN HOTELMASTER ON HOTELBOOKINGMASTER.BOOKING_HOTELID = HOTELMASTER.HOTEL_ID AND HOTELBOOKINGMASTER.BOOKING_CMPID = HOTELMASTER.HOTEL_CMPID AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = HOTELMASTER.HOTEL_LOCATIONID AND HOTELBOOKINGMASTER.BOOKING_YEARID = HOTELMASTER.HOTEL_YEARID ON OTHERCHGS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND OTHERCHGS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND OTHERCHGS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND OTHERCHGS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGSID LEFT OUTER JOIN TAXMASTER AS ADDTAXMASTER ON HOTELBOOKINGMASTER.BOOKING_PURADDTAXID = ADDTAXMASTER.tax_id AND HOTELBOOKINGMASTER.BOOKING_CMPID = ADDTAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = ADDTAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_YEARID = ADDTAXMASTER.tax_yearid LEFT OUTER JOIN TAXMASTER ON HOTELBOOKINGMASTER.BOOKING_YEARID = TAXMASTER.tax_yearid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = TAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_CMPID = TAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_PURTAXID = TAXMASTER.tax_id ON LEDGERS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND LEDGERS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND LEDGERS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND LEDGERS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PURLEDGERID ) AS T ", " AND T.BILLNO = 'P-" & BILLNO & "' AND T.CMPID = " & CmpId & " AND T.LOCATIONID = " & Locationid & " AND T.YEARID = " & YearId)
                        End If
                    ElseIf TYPE = "HOLIDAYPACKAGE" Then
                        'DTNEW = OBJCMN.search(" * ", "", " (SELECT 'HOTELBOOKING' AS TYPE, BOOKING_ARRIVAL AS ARRIVAL, BOOKING_PURAMTPAID AS PAIDAMT, BOOKING_PURBILLINITIALS AS BILLNO, BOOKING_CMPID AS CMPID, BOOKING_LOCATIONID AS LOCATIONID, BOOKING_YEARID AS YEARID , ISNULL(GUESTMASTER.GUEST_NAME,'') AS GUESTNAME, ISNULL(HOTELMASTER.HOTEL_NAME,'') AS HOTELNAME, ISNULL(LEDGERS.Acc_cmpname,'') AS NAME, HOTELBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURAMT, HOTELBOOKINGMASTER.BOOKING_DISCRECDPER AS DISCPER, HOTELBOOKINGMASTER.BOOKING_DISCRECDRS AS DISCRS, HOTELBOOKINGMASTER.BOOKING_COMMRECDPER AS COMMPER, HOTELBOOKINGMASTER.BOOKING_COMMRECDRS AS COMMRS, HOTELBOOKINGMASTER.BOOKING_PURTDSPER AS TDSPER, HOTELBOOKINGMASTER.BOOKING_PURTDSRS AS TDSRS, HOTELBOOKINGMASTER.BOOKING_PUREXTRACHGS AS EXTRACHGS, ISNULL(TAXMASTER.tax_name,'') AS TAXNAME, HOTELBOOKINGMASTER.BOOKING_PURTAX AS TAXAMT, ISNULL(ADDTAXMASTER.tax_name,'') AS ADDTAXNAME, HOTELBOOKINGMASTER.BOOKING_PURADDTAX AS ADDTAXAMT, ISNULL(OTHERCHGS.Acc_cmpname,'') AS OTHERCHGSNAME, HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGS AS OTHERCHGS, HOTELBOOKINGMASTER.BOOKING_PURROUNDOFF AS ROUNDOFF, HOTELBOOKINGMASTER.BOOKING_PURGRANDTOTAL AS GTOTAL, 0 AS DP FROM LEDGERS RIGHT OUTER JOIN LEDGERS AS OTHERCHGS RIGHT OUTER JOIN GUESTMASTER INNER JOIN HOTELBOOKINGMASTER ON GUESTMASTER.GUEST_ID = HOTELBOOKINGMASTER.BOOKING_GUESTID AND GUESTMASTER.GUEST_CMPID = HOTELBOOKINGMASTER.BOOKING_CMPID AND GUESTMASTER.GUEST_LOCATIONID = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND GUESTMASTER.GUEST_YEARID = HOTELBOOKINGMASTER.BOOKING_YEARID INNER JOIN HOTELMASTER ON HOTELBOOKINGMASTER.BOOKING_HOTELID = HOTELMASTER.HOTEL_ID AND HOTELBOOKINGMASTER.BOOKING_CMPID = HOTELMASTER.HOTEL_CMPID AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = HOTELMASTER.HOTEL_LOCATIONID AND HOTELBOOKINGMASTER.BOOKING_YEARID = HOTELMASTER.HOTEL_YEARID ON OTHERCHGS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND OTHERCHGS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND OTHERCHGS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND OTHERCHGS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGSID LEFT OUTER JOIN TAXMASTER AS ADDTAXMASTER ON HOTELBOOKINGMASTER.BOOKING_PURADDTAXID = ADDTAXMASTER.tax_id AND HOTELBOOKINGMASTER.BOOKING_CMPID = ADDTAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = ADDTAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_YEARID = ADDTAXMASTER.tax_yearid LEFT OUTER JOIN TAXMASTER ON HOTELBOOKINGMASTER.BOOKING_YEARID = TAXMASTER.tax_yearid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = TAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_CMPID = TAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_PURTAXID = TAXMASTER.tax_id ON LEDGERS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND LEDGERS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND LEDGERS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND LEDGERS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PURLEDGERID ) AS T ", " AND T.BILLNO = 'HP-" & BILLNO & "' AND T.CMPID = " & CmpId & " AND T.LOCATIONID = " & Locationid & " AND T.YEARID = " & YearId)
                        DTNEW = OBJCMN.search(" * ", "", " (SELECT 'HOTELBOOKING' AS TYPE, HOTELBOOKINGMASTER.BOOKING_ARRIVAL AS ARRIVAL, HOTELBOOKINGMASTER.BOOKING_PURAMTPAID AS PAIDAMT,HOTELBOOKINGMASTER.BOOKING_PURBILLINITIALS AS BILLNO, HOTELBOOKINGMASTER.BOOKING_CMPID AS CMPID, HOTELBOOKINGMASTER.BOOKING_LOCATIONID AS LOCATIONID, HOTELBOOKINGMASTER.BOOKING_YEARID AS YEARID, ISNULL(GUESTMASTER.GUEST_NAME, '') AS GUESTNAME, ISNULL(HOTELMASTER.HOTEL_NAME, '') AS HOTELNAME, ISNULL(LEDGERS.Acc_cmpname, '') AS NAME, HOTELBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURAMT, HOTELBOOKINGMASTER.BOOKING_DISCRECDPER AS DISCPER, HOTELBOOKINGMASTER.BOOKING_DISCRECDRS AS DISCRS, HOTELBOOKINGMASTER.BOOKING_COMMRECDPER AS COMMPER, HOTELBOOKINGMASTER.BOOKING_COMMRECDRS AS COMMRS, HOTELBOOKINGMASTER.BOOKING_PURTDSPER AS TDSPER, HOTELBOOKINGMASTER.BOOKING_PURTDSRS AS TDSRS, HOTELBOOKINGMASTER.BOOKING_PUREXTRACHGS AS EXTRACHGS, ISNULL(TAXMASTER.tax_name, '') AS TAXNAME, HOTELBOOKINGMASTER.BOOKING_PURTAX AS TAXAMT, ISNULL(ADDTAXMASTER.tax_name, '') AS ADDTAXNAME, HOTELBOOKINGMASTER.BOOKING_PURADDTAX AS ADDTAXAMT, ISNULL(OTHERCHGS.Acc_cmpname, '') AS OTHERCHGSNAME, HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGS AS OTHERCHGS, HOTELBOOKINGMASTER.BOOKING_PURROUNDOFF AS ROUNDOFF, HOTELBOOKINGMASTER.BOOKING_PURGRANDTOTAL AS GTOTAL, 0 AS DP, ISNULL(CAST(STATEMASTER.state_remark AS VARCHAR), '') AS STATECODE, ISNULL(HOTELBOOKINGMASTER.BOOKING_PUROURCOMMPER, 0) AS SERVCHGS, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURTAXSERVCHGS, 0) AS TAXSERVCHGS, ISNULL(HSNMASTER.HSN_ITEMDESC, '') AS ITEMDESC, ISNULL(HSNMASTER.HSN_CODE, '') AS HSNCODE, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURCGSTPER, 0) AS CGSTPER, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURCGSTAMT, 0) AS CGSTAMT, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURSGSTPER, 0) AS SGSTPER, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURSGSTAMT, 0) AS SGSTAMT, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURIGSTPER, 0) AS IGSTPER, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURIGSTAMT, 0) AS IGSTAMT FROM STATEMASTER RIGHT OUTER JOIN LEDGERS ON STATEMASTER.state_id = LEDGERS.Acc_stateid RIGHT OUTER JOIN TAXMASTER RIGHT OUTER JOIN HSNMASTER RIGHT OUTER JOIN GUESTMASTER INNER JOIN HOTELBOOKINGMASTER ON GUESTMASTER.GUEST_ID = HOTELBOOKINGMASTER.BOOKING_GUESTID AND GUESTMASTER.GUEST_CMPID = HOTELBOOKINGMASTER.BOOKING_CMPID AND GUESTMASTER.GUEST_LOCATIONID = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND GUESTMASTER.GUEST_YEARID = HOTELBOOKINGMASTER.BOOKING_YEARID INNER JOIN HOTELMASTER ON HOTELBOOKINGMASTER.BOOKING_HOTELID = HOTELMASTER.HOTEL_ID AND HOTELBOOKINGMASTER.BOOKING_CMPID = HOTELMASTER.HOTEL_CMPID AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = HOTELMASTER.HOTEL_LOCATIONID AND HOTELBOOKINGMASTER.BOOKING_YEARID = HOTELMASTER.HOTEL_YEARID ON HSNMASTER.HSN_ID = HOTELBOOKINGMASTER.BOOKING_PURHSNCODEID LEFT OUTER JOIN LEDGERS AS OTHERCHGS ON HOTELBOOKINGMASTER.BOOKING_YEARID = OTHERCHGS.Acc_yearid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = OTHERCHGS.Acc_locationid AND HOTELBOOKINGMASTER.BOOKING_CMPID = OTHERCHGS.Acc_cmpid AND HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGSID = OTHERCHGS.Acc_id LEFT OUTER JOIN TAXMASTER AS ADDTAXMASTER ON HOTELBOOKINGMASTER.BOOKING_PURADDTAXID = ADDTAXMASTER.tax_id AND HOTELBOOKINGMASTER.BOOKING_CMPID = ADDTAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = ADDTAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_YEARID = ADDTAXMASTER.tax_yearid ON TAXMASTER.tax_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND TAXMASTER.tax_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND TAXMASTER.tax_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND TAXMASTER.tax_id = HOTELBOOKINGMASTER.BOOKING_PURTAXID ON LEDGERS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND LEDGERS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND LEDGERS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND LEDGERS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PURLEDGERID) AS T ", " AND T.BILLNO = 'HP-" & BILLNO & "' AND T.CMPID = " & CmpId & " AND T.LOCATIONID = " & Locationid & " AND T.YEARID = " & YearId)

                    ElseIf TYPE = "INTERNATIONALBOOKING" Then
                        DTNEW = OBJCMN.search(" * ", "", " (SELECT 'HOTELBOOKING' AS TYPE, HOTELBOOKINGMASTER.BOOKING_ARRIVAL AS ARRIVAL, HOTELBOOKINGMASTER.BOOKING_PURAMTPAID AS PAIDAMT, HOTELBOOKINGMASTER.BOOKING_PURBILLINITIALS AS BILLNO, HOTELBOOKINGMASTER.BOOKING_CMPID AS CMPID,HOTELBOOKINGMASTER.BOOKING_LOCATIONID AS LOCATIONID, HOTELBOOKINGMASTER.BOOKING_YEARID AS YEARID, ISNULL(GUESTMASTER.GUEST_NAME, '') AS GUESTNAME, ISNULL(HOTELMASTER.HOTEL_NAME, '') AS HOTELNAME, ISNULL(LEDGERS.Acc_cmpname, '') AS NAME, HOTELBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURAMT, HOTELBOOKINGMASTER.BOOKING_DISCRECDPER AS DISCPER, HOTELBOOKINGMASTER.BOOKING_DISCRECDRS AS DISCRS, HOTELBOOKINGMASTER.BOOKING_COMMRECDPER AS COMMPER, HOTELBOOKINGMASTER.BOOKING_COMMRECDRS AS COMMRS, HOTELBOOKINGMASTER.BOOKING_PURTDSPER AS TDSPER, HOTELBOOKINGMASTER.BOOKING_PURTDSRS AS TDSRS, HOTELBOOKINGMASTER.BOOKING_PUREXTRACHGS AS EXTRACHGS, ISNULL(TAXMASTER.tax_name, '') AS TAXNAME, HOTELBOOKINGMASTER.BOOKING_PURTAX AS TAXAMT, ISNULL(ADDTAXMASTER.tax_name, '') AS ADDTAXNAME, HOTELBOOKINGMASTER.BOOKING_PURADDTAX AS ADDTAXAMT, ISNULL(OTHERCHGS.Acc_cmpname, '') AS OTHERCHGSNAME, HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGS AS OTHERCHGS, HOTELBOOKINGMASTER.BOOKING_PURROUNDOFF AS ROUNDOFF, HOTELBOOKINGMASTER.BOOKING_PURGRANDTOTAL AS GTOTAL, 0 AS DP, ISNULL(CAST(STATEMASTER.state_remark AS VARCHAR), '') AS STATECODE, ISNULL(HSNMASTER.HSN_ITEMDESC, '') AS ITEMDESC, ISNULL(HSNMASTER.HSN_CODE, '') AS HSNCODE, ISNULL(HOTELBOOKINGMASTER.BOOKING_PUROURCOMMPER, 0) AS SERVCHGS, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURTAXSERVCHGS, 0) AS TAXSERVCHGS, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURCGSTPER, 0) AS CGSTPER, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURCGSTAMT, 0) AS CGSTAMT, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURSGSTPER, 0) AS SGSTPER, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURSGSTAMT, 0) AS SGSTAMT, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURIGSTPER, 0) AS IGSTPER, ISNULL(HOTELBOOKINGMASTER.BOOKING_PURIGSTAMT, 0) AS IGSTAMT FROM TAXMASTER RIGHT OUTER JOIN HSNMASTER RIGHT OUTER JOIN GUESTMASTER INNER JOIN HOTELBOOKINGMASTER ON GUESTMASTER.GUEST_ID = HOTELBOOKINGMASTER.BOOKING_GUESTID AND GUESTMASTER.GUEST_CMPID = HOTELBOOKINGMASTER.BOOKING_CMPID AND GUESTMASTER.GUEST_LOCATIONID = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND GUESTMASTER.GUEST_YEARID = HOTELBOOKINGMASTER.BOOKING_YEARID INNER JOIN HOTELMASTER ON HOTELBOOKINGMASTER.BOOKING_HOTELID = HOTELMASTER.HOTEL_ID AND HOTELBOOKINGMASTER.BOOKING_CMPID = HOTELMASTER.HOTEL_CMPID AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = HOTELMASTER.HOTEL_LOCATIONID AND HOTELBOOKINGMASTER.BOOKING_YEARID = HOTELMASTER.HOTEL_YEARID ON HSNMASTER.HSN_ID = HOTELBOOKINGMASTER.BOOKING_PURHSNCODEID LEFT OUTER JOIN LEDGERS AS OTHERCHGS ON HOTELBOOKINGMASTER.BOOKING_YEARID = OTHERCHGS.Acc_yearid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = OTHERCHGS.Acc_locationid AND HOTELBOOKINGMASTER.BOOKING_CMPID = OTHERCHGS.Acc_cmpid AND HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGSID = OTHERCHGS.Acc_id LEFT OUTER JOIN TAXMASTER AS ADDTAXMASTER ON HOTELBOOKINGMASTER.BOOKING_PURADDTAXID = ADDTAXMASTER.tax_id AND HOTELBOOKINGMASTER.BOOKING_CMPID = ADDTAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = ADDTAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_YEARID = ADDTAXMASTER.tax_yearid ON TAXMASTER.tax_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND TAXMASTER.tax_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND TAXMASTER.tax_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND TAXMASTER.tax_id = HOTELBOOKINGMASTER.BOOKING_PURTAXID LEFT OUTER JOIN LEDGERS LEFT OUTER JOIN STATEMASTER ON LEDGERS.Acc_stateid = STATEMASTER.state_id ON HOTELBOOKINGMASTER.BOOKING_CMPID = LEDGERS.Acc_cmpid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = LEDGERS.Acc_locationid AND HOTELBOOKINGMASTER.BOOKING_YEARID = LEDGERS.Acc_yearid AND HOTELBOOKINGMASTER.BOOKING_PURLEDGERID = LEDGERS.Acc_id ) AS T ", " AND T.BILLNO = 'IP-" & BILLNO & "' AND T.CMPID = " & CmpId & " AND T.LOCATIONID = " & Locationid & " AND T.YEARID = " & YearId)
                        'DTNEW = OBJCMN.search(" * ", "", " (SELECT 'HOTELBOOKING' AS TYPE, BOOKING_ARRIVAL AS ARRIVAL, BOOKING_PURAMTPAID AS PAIDAMT, BOOKING_PURBILLINITIALS AS BILLNO, BOOKING_CMPID AS CMPID, BOOKING_LOCATIONID AS LOCATIONID, BOOKING_YEARID AS YEARID , ISNULL(GUESTMASTER.GUEST_NAME,'') AS GUESTNAME, ISNULL(HOTELMASTER.HOTEL_NAME,'') AS HOTELNAME, ISNULL(LEDGERS.Acc_cmpname,'') AS NAME, HOTELBOOKINGMASTER.BOOKING_TOTALPURAMT AS PURAMT, HOTELBOOKINGMASTER.BOOKING_DISCRECDPER AS DISCPER, HOTELBOOKINGMASTER.BOOKING_DISCRECDRS AS DISCRS, HOTELBOOKINGMASTER.BOOKING_COMMRECDPER AS COMMPER, HOTELBOOKINGMASTER.BOOKING_COMMRECDRS AS COMMRS, HOTELBOOKINGMASTER.BOOKING_PURTDSPER AS TDSPER, HOTELBOOKINGMASTER.BOOKING_PURTDSRS AS TDSRS, HOTELBOOKINGMASTER.BOOKING_PUREXTRACHGS AS EXTRACHGS, ISNULL(TAXMASTER.tax_name,'') AS TAXNAME, HOTELBOOKINGMASTER.BOOKING_PURTAX AS TAXAMT, ISNULL(ADDTAXMASTER.tax_name,'') AS ADDTAXNAME, HOTELBOOKINGMASTER.BOOKING_PURADDTAX AS ADDTAXAMT, ISNULL(OTHERCHGS.Acc_cmpname,'') AS OTHERCHGSNAME, HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGS AS OTHERCHGS, HOTELBOOKINGMASTER.BOOKING_PURROUNDOFF AS ROUNDOFF, HOTELBOOKINGMASTER.BOOKING_PURGRANDTOTAL AS GTOTAL, 0 AS DP FROM LEDGERS RIGHT OUTER JOIN LEDGERS AS OTHERCHGS RIGHT OUTER JOIN GUESTMASTER INNER JOIN HOTELBOOKINGMASTER ON GUESTMASTER.GUEST_ID = HOTELBOOKINGMASTER.BOOKING_GUESTID AND GUESTMASTER.GUEST_CMPID = HOTELBOOKINGMASTER.BOOKING_CMPID AND GUESTMASTER.GUEST_LOCATIONID = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND GUESTMASTER.GUEST_YEARID = HOTELBOOKINGMASTER.BOOKING_YEARID INNER JOIN HOTELMASTER ON HOTELBOOKINGMASTER.BOOKING_HOTELID = HOTELMASTER.HOTEL_ID AND HOTELBOOKINGMASTER.BOOKING_CMPID = HOTELMASTER.HOTEL_CMPID AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = HOTELMASTER.HOTEL_LOCATIONID AND HOTELBOOKINGMASTER.BOOKING_YEARID = HOTELMASTER.HOTEL_YEARID ON OTHERCHGS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND OTHERCHGS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND OTHERCHGS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND OTHERCHGS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PUROTHERCHGSID LEFT OUTER JOIN TAXMASTER AS ADDTAXMASTER ON HOTELBOOKINGMASTER.BOOKING_PURADDTAXID = ADDTAXMASTER.tax_id AND HOTELBOOKINGMASTER.BOOKING_CMPID = ADDTAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = ADDTAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_YEARID = ADDTAXMASTER.tax_yearid LEFT OUTER JOIN TAXMASTER ON HOTELBOOKINGMASTER.BOOKING_YEARID = TAXMASTER.tax_yearid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = TAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_CMPID = TAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_PURTAXID = TAXMASTER.tax_id ON LEDGERS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND LEDGERS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND LEDGERS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND LEDGERS.Acc_id = HOTELBOOKINGMASTER.BOOKING_PURLEDGERID ) AS T ", " AND T.BILLNO = 'IP-" & BILLNO & "' AND T.CMPID = " & CmpId & " AND T.LOCATIONID = " & Locationid & " AND T.YEARID = " & YearId)
                    End If



                    If DTNEW.Rows.Count > 0 Then

                        If Val(DTNEW.Rows(0).Item("GTOTAL")) <= 0 Then
                            MsgBox("Debit note cannot be Raised as Purchase Value 0", MsgBoxStyle.Critical)
                            Exit Sub
                        End If

                        If DTNEW.Rows(0).Item("PAIDAMT") > 0 Then
                            MsgBox("Payment Made, Delete Payment First", MsgBoxStyle.Critical)
                            Exit Sub
                        End If

                        alParaval.Clear()

                        alParaval.Add("DEBIT NOTE")
                        alParaval.Add(DTNEW.Rows(0).Item("TYPE"))
                        alParaval.Add(CNDATE.Value) 'SAME AS CREDIT NOTE

                        'IF BILLNO IS NOT THERE THEN ARRIVAL DATE SAME AS DNDATE
                        alParaval.Add(DTNEW.Rows(0).Item("ARRIVAL"))

                        alParaval.Add(DTNEW.Rows(0).Item("BILLNO"))
                        alParaval.Add(0)

                        alParaval.Add(DTNEW.Rows(0).Item("GUESTNAME"))
                        alParaval.Add(DTNEW.Rows(0).Item("HOTELNAME"))
                        alParaval.Add(DTNEW.Rows(0).Item("NAME"))
                        alParaval.Add(DTNEW.Rows(0).Item("HSNCODE"))

                        alParaval.Add(Val(DTNEW.Rows(0).Item("PURAMT")) + Val(DTNEW.Rows(0).Item("EXTRACHGS")))
                        'alParaval.Add(Val(DTNEW.Rows(0).Item("DISCPER")))
                        alParaval.Add(0)
                        alParaval.Add(Val(DTNEW.Rows(0).Item("DISCRS")))
                        'alParaval.Add(Val(DTNEW.Rows(0).Item("COMMPER")))
                        alParaval.Add(0)
                        alParaval.Add(Val(DTNEW.Rows(0).Item("COMMRS")))
                        'alParaval.Add(Val(DTNEW.Rows(0).Item("TDSPER")))
                        alParaval.Add(0)
                        alParaval.Add(Val(DTNEW.Rows(0).Item("TDSRS")))
                        alParaval.Add(Val(DTNEW.Rows(0).Item("EXTRACHGS")))

                        alParaval.Add(Val(DTNEW.Rows(0).Item("SERVCHGS")))
                        If Convert.ToBoolean(DTNEW.Rows(0).Item("TAXSERVCHGS")) = "FALSE" Then alParaval.Add(0) Else alParaval.Add(1)
                        If Convert.ToBoolean(DTNEW.Rows(0).Item("MANUALGST")) = "FALSE" Then alParaval.Add(0) Else alParaval.Add(1)

                        alParaval.Add(Val(Val(DTNEW.Rows(0).Item("PURAMT")) + Val(DTNEW.Rows(0).Item("EXTRACHGS")) + Val(DTNEW.Rows(0).Item("SERVCHGS"))) - Val(DTNEW.Rows(0).Item("DISCRS")) - Val(DTNEW.Rows(0).Item("COMMRS")))

                        alParaval.Add(DTNEW.Rows(0).Item("TAXNAME"))
                        alParaval.Add(Val(DTNEW.Rows(0).Item("TAXAMT")))
                        alParaval.Add(DTNEW.Rows(0).Item("ADDTAXNAME"))
                        alParaval.Add(Val(DTNEW.Rows(0).Item("ADDTAXAMT")))

                        alParaval.Add(DTNEW.Rows(0).Item("OTHERCHGSNAME"))
                        If cmbaddsub.Text.Trim = "Add" Then
                            alParaval.Add(Val(DTNEW.Rows(0).Item("OTHERCHGS")))
                        ElseIf cmbaddsub.Text.Trim = "Sub." Then
                            alParaval.Add(Val((DTNEW.Rows(0).Item("OTHERCHGS")) * (-1)))
                        Else
                            alParaval.Add(0)
                        End If

                        alParaval.Add(Val(DTNEW.Rows(0).Item("CGSTPER")))
                        alParaval.Add(Val(DTNEW.Rows(0).Item("CGSTAMT")))
                        alParaval.Add(Val(DTNEW.Rows(0).Item("SGSTPER")))
                        alParaval.Add(Val(DTNEW.Rows(0).Item("SGSTAMT")))

                        alParaval.Add(Val(DTNEW.Rows(0).Item("IGSTPER")))
                        alParaval.Add(Val(DTNEW.Rows(0).Item("IGSTAMT")))

                        alParaval.Add(Val(DTNEW.Rows(0).Item("ROUNDOFF")))
                        alParaval.Add(Val(DTNEW.Rows(0).Item("GTOTAL")))
                        alParaval.Add(Val(DTNEW.Rows(0).Item("DP")))

                        alParaval.Add(DTNEW.Rows(0).Item("BILLNO")) 'SEND BILLNO AS REMARKS
                        alParaval.Add(ClientName)
                        alParaval.Add(CmpId)
                        alParaval.Add(Locationid)
                        alParaval.Add(Userid)
                        alParaval.Add(YearId)
                        alParaval.Add(0)

                        alParaval.Add("")               'IRNNO
                        alParaval.Add("")               'ACKNO
                        alParaval.Add(CNDATE.Value.Date) 'ACKDATE
                        alParaval.Add(DBNull.Value)     'QRCODE
                        If CHKNOGSTR1.Checked = True Then alParaval.Add(1) Else alParaval.Add(0)


                        Dim objclsDNmaster As New ClsDebitNote()
                        objclsDNmaster.alParaval = alParaval
                        Dim DT As DataTable

                        If edit = False Then
                            If USERADD = False Then
                                MsgBox("Insufficient Rights")
                                Exit Sub
                            End If
                            DT = objclsDNmaster.save()
                            MessageBox.Show("Details Added")
                        End If

                    End If

                End If
            End If

            clear()
            edit = False
            TXTBILLNO.Focus()

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Function errorvalid() As Boolean
        Dim bln As Boolean = True

        If Not datecheck(CNDATE.Value) Then
            EP.SetError(CNDATE, "Date Not in Current Accounting Year")
            bln = False
        End If

        If cmbregister.Text.Trim.Length = 0 Then
            EP.SetError(cmbregister, "Select Register Name")
            bln = False
        End If

        'CHEKCING IN HOTELBOOKINGS WHETHER CN IS MADE OR NOT
        If TXTBILLNO.Text.Trim <> "" And edit = False Then
            Dim OBJCMN As New ClsCommon
            Dim DT As DataTable = OBJCMN.search(" * ", "", " (SELECT BOOKING_SALERETURN AS SALERETURN, BOOKING_SALEBILLINITIALS AS INITIALS, BOOKING_CMPID AS CMPID, BOOKING_LOCATIONID AS LOCATIONID, BOOKING_YEARID AS YEARID FROM HOTELBOOKINGMASTER UNION ALL SELECT BOOKING_SALERETURN AS SALERETURN, BOOKING_SALEBILLINITIALS AS INITIALS, BOOKING_CMPID AS CMPID, BOOKING_LOCATIONID AS LOCATIONID, BOOKING_YEARID AS YEARID FROM HOLIDAYPACKAGEMASTER UNION ALL SELECT BOOKING_SALERETURN AS SALERETURN, BOOKING_SALEBILLINITIALS AS INITIALS, BOOKING_CMPID AS CMPID, BOOKING_LOCATIONID AS LOCATIONID, BOOKING_YEARID AS YEARID FROM RAILBOOKINGMASTER UNION ALL SELECT BOOKING_SALERETURN AS SALERETURN, BOOKING_SALEBILLINITIALS AS INITIALS, BOOKING_CMPID AS CMPID, BOOKING_LOCATIONID AS LOCATIONID, BOOKING_YEARID AS YEARID FROM CARBOOKINGMASTER )AS T ", " AND T.INITIALS = '" & TXTBILLNO.Text.Trim & "'  AND T.CMPID = " & CmpId & " AND T.LOCATIONID = " & Locationid & " AND T.YEARID = " & YearId)
            If DT.Rows.Count > 0 Then
                If Val(DT.Rows(0).Item("SALERETURN")) > 0 Then
                    EP.SetError(TXTBILLNO, "Credit Note Already Raised")
                    bln = False
                End If
            End If
        End If

        If ClientName <> "SEASONED" Then
            If TYPE = "HOTELBOOKING" Then
                If TXTBILLNO.Text.Trim <> "" And TXTGUESTNAME.Text.Trim = "" Then
                    EP.SetError(TXTGUESTNAME, "Select Booking Voucher")
                    bln = False
                End If

                If TXTBILLNO.Text.Trim <> "" And TXTHOTELNAME.Text.Trim = "" Then
                    EP.SetError(TXTHOTELNAME, "Select Booking Voucher")
                    bln = False
                End If
            End If
        End If

        If CMBNAME.Text.Trim = "" Then
            EP.SetError(CMBNAME, "Select Booking Voucher")
            bln = False
        End If


        If txtgrandtotal.Text.Trim = "" Then
            EP.SetError(txtgrandtotal, "Enter Amount")
            bln = False
        End If

        If ClientName = "CLASSIC" Then
            If UserName <> "Admin" And edit = False Then
                If CNDATE.Value.Date < Now.Date Then
                    EP.SetError(CNDATE, "Back Date Entry Not Allowed")
                    bln = False
                End If
            End If
        End If

        If Not datecheck(CNDATE.Value) Then
            EP.SetError(CNDATE, "Date Not in Current Accounting Year")
            bln = False
        End If

        'as per ASHOK SIR
        'If TYPE <> "MISCELLANEOUSSALE" Then
        '    If Not datecheck(ARRIVALDATE.Value) Then
        '        EP.SetError(ARRIVALDATE, "Date Not in Current Accounting Year")
        '        bln = False
        '    End If
        'End If
        Return bln

    End Function

    Private Sub CN_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles MyBase.KeyDown
        Try

            If (e.KeyCode = Windows.Forms.Keys.Escape) Then   'for Exit
                If errorvalid() = True Then
                    Dim tempmsg As Integer = MessageBox.Show("Save Changes?", "", MessageBoxButtons.YesNo)
                    If tempmsg = vbYes Then cmdok_Click(sender, e)
                End If
                Me.Close()
            ElseIf e.KeyCode = Keys.Oemcomma Then
                e.SuppressKeyPress = True
            ElseIf e.KeyCode = Keys.Enter Then
                SendKeys.Send("{Tab}")
            ElseIf e.KeyCode = Keys.F2 Then
                tstxtbillno.Focus()
            ElseIf e.KeyCode = Keys.Left And e.Alt = True Then
                Call toolprevious_Click(sender, e)
            ElseIf e.KeyCode = Keys.Right And e.Alt = True Then
                Call toolnext_Click(sender, e)
            ElseIf e.Alt = True And e.KeyCode = Windows.Forms.Keys.F1 Then
                Dim OBJINVDTLS As New CreditNoteDetails
                OBJINVDTLS.MdiParent = MDIMain
                OBJINVDTLS.Show()
            ElseIf e.KeyCode = Keys.P And e.Alt = True Then
                Call PrintToolStripButton_Click(sender, e)
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub cmbregister_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles cmbregister.Validating
        Try
            If cmbregister.Text.Trim.Length > 0 And edit = False Then
                'clear()
                cmbregister.Text = UCase(cmbregister.Text)
                Dim clscommon As New ClsCommon
                Dim dt As DataTable
                dt = clscommon.search(" register_abbr, register_initials, register_id", "", " RegisterMaster", " and register_name ='" & cmbregister.Text.Trim & "' and register_type = 'CREDITNOTE' and register_cmpid = " & CmpId & " and register_LOCATIONid = " & Locationid & " and register_YEARid = " & YearId)
                If dt.Rows.Count > 0 Then
                    CNREGABBR = dt.Rows(0).Item(0).ToString
                    CNREGINITIAL = dt.Rows(0).Item(1).ToString
                    CNREGID = dt.Rows(0).Item(2)
                    getmaxno_CN()
                    cmbregister.Enabled = False
                Else
                    MsgBox("Register Not Present, Add New from Master Module")
                    e.Cancel = True
                End If
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub SaveToolStripButton_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles SaveToolStripButton.Click
        Call cmdok_Click(sender, e)
    End Sub

    Private Sub OpenToolStripButton_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles OpenToolStripButton.Click
        Try
            If USEREDIT = False And USERVIEW = False Then
                MsgBox("Insufficient Rights")
                Exit Sub
            End If
            Dim objCNdtls As New CreditNoteDetails
            objCNdtls.MdiParent = MDIMain
            objCNdtls.Show()
            objCNdtls.BringToFront()
            Me.Close()
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub CMBOTHERCHGS_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles CMBOTHERCHGS.Enter
        Try
            If ClientName = "CLASSIC" Then
                If CMBOTHERCHGS.Text.Trim = "" Then fillname(CMBOTHERCHGS, edit, " AND GROUP_SECONDARY = 'INDIRECT EXPENSES'")
            Else
                If CMBOTHERCHGS.Text.Trim = "" Then fillname(CMBOTHERCHGS, edit, " AND (GROUP_SECONDARY = 'INDIRECT EXPENSES' OR GROUP_SECONDARY = 'INDIRECT INCOME' OR GROUP_SECONDARY = 'DIRECT EXPENSES' OR GROUP_SECONDARY = 'DIRECT INCOME')")
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub CMBOTHERCHGS_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles CMBOTHERCHGS.Validating
        Try
            If ClientName = "CLASSIC" Then
                If CMBOTHERCHGS.Text.Trim <> "" Then namevalidate(CMBOTHERCHGS, CMBOTHERCHGSCODE, e, Me, TXTOTHERCHGSADD, " AND GROUPMASTER.GROUP_SECONDARY = 'INDIRECT EXPENSES'", "INDIRECT EXPENSES")
            Else
                If CMBOTHERCHGS.Text.Trim <> "" Then namevalidate(CMBOTHERCHGS, CMBOTHERCHGSCODE, e, Me, TXTOTHERCHGSADD, " AND (GROUP_SECONDARY = 'INDIRECT EXPENSES' OR GROUP_SECONDARY = 'INDIRECT INCOME' OR GROUP_SECONDARY = 'DIRECT EXPENSES' OR GROUP_SECONDARY = 'DIRECT INCOME')", "")
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub cmbtax_GotFocus(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbtax.GotFocus
        Try
            If cmbtax.Text.Trim = "" Then filltax(cmbtax, edit)
        Catch ex As Exception
            If ErrHandle(ex.Message.GetHashCode) = False Then Throw ex
        End Try
    End Sub

    Private Sub cmbtax_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles cmbtax.Validating
        Try
            If cmbtax.Text.Trim <> "" Then TAXvalidate(cmbtax, e, Me)
            TOTAL()
        Catch ex As Exception
            If ErrHandle(ex.Message.GetHashCode) = False Then Throw ex
        End Try
    End Sub

    Sub FILLCMB()
        Try
            filltax(cmbtax, edit)
            'filltax(CMBADDTAX, edit)

            'fillname(CMBNAME, edit, " AND GROUP_SECONDARY = 'SUNDRY DEBTORS'")
            fillname(CMBNAME, edit, " AND (GROUP_SECONDARY = 'SUNDRY DEBTORS' OR GROUP_SECONDARY = 'SUNDRY CREDITORS')")
            If ClientName = "CLASSIC" Then
                fillname(CMBOTHERCHGS, edit, " AND GROUP_SECONDARY = 'INDIRECT EXPENSES'")
            Else
                fillname(CMBOTHERCHGS, edit, " AND (GROUP_SECONDARY = 'INDIRECT EXPENSES' OR GROUP_SECONDARY = 'INDIRECT INCOME' OR GROUP_SECONDARY = 'DIRECT EXPENSES' OR GROUP_SECONDARY = 'DIRECT INCOME')")
            End If
            fillregister(cmbregister, " and register_type = 'CREDITNOTE'  and REGISTER_NAME <> 'AIRLINE CREDITNOTE' ")
            If CMBHSNITEMDESC.Text.Trim = "" Then FILLHSNITEMDESC(CMBHSNITEMDESC)

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub CMBNAME_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles CMBNAME.Enter
        Try
            'If CMBNAME.Text.Trim = "" Then fillname(CMBNAME, edit, " AND GROUP_SECONDARY = 'SUNDRY DEBTORS'")
            If CMBNAME.Text.Trim = "" Then fillname(CMBNAME, edit, " AND (GROUP_SECONDARY = 'SUNDRY DEBTORS' OR GROUP_SECONDARY = 'SUNDRY CREDITORS')")

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub CMBNAME_KeyDown(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles CMBNAME.KeyDown
        Try
            If e.KeyCode = Keys.Oemcomma Then e.SuppressKeyPress = True
            If e.KeyCode = Keys.OemQuotes Then e.SuppressKeyPress = True
            If e.KeyCode = Keys.F1 Then
                Dim OBJLEDGER As New SelectLedger
                'OBJLEDGER.STRSEARCH = " AND GROUPMASTER.GROUP_SECONDARY ='SUNDRY DEBTORS'"
                OBJLEDGER.STRSEARCH = " AND (GROUP_SECONDARY = 'SUNDRY DEBTORS' OR GROUP_SECONDARY = 'SUNDRY CREDITORS')"
                OBJLEDGER.ShowDialog()
                If OBJLEDGER.TEMPCODE <> "" Then CMBACCCODE.Text = OBJLEDGER.TEMPCODE
                If OBJLEDGER.TEMPNAME <> "" Then CMBNAME.Text = OBJLEDGER.TEMPNAME
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Sub GETSTATECODE()
        Try
            If CMBNAME.Text.Trim <> "" Then
                Dim OBJCMN As New ClsCommon
                Dim DT As DataTable = OBJCMN.search(" ISNULL(STATEMASTER.state_remark, '') AS STATECODE, ISNULL(GROUPMASTER.GROUP_SECONDARY,'') AS SECONDARY ", "", " LEDGERS LEFT OUTER JOIN STATEMASTER ON LEDGERS.Acc_stateid = STATEMASTER.state_id INNER JOIN GROUPMASTER ON LEDGERS.ACC_GROUPID = GROUPMASTER.GROUP_ID", " and LEDGERS.acc_cmpname = '" & CMBNAME.Text.Trim & "'  and LEDGERS.acc_YEARid = " & YearId)
                If DT.Rows.Count > 0 Then
                    If DT.Rows(0).Item("SECONDARY") = "Sundry Creditors" Then CHKNOGSTR1.CheckState = CheckState.Checked
                    TXTSTATECODE.Text = DT.Rows(0).Item("STATECODE")
                End If

                GETHSNCODE()
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub CMBNAME_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles CMBNAME.Validated
        Try
            GETSTATECODE()
            CMBNAME.Enabled = False
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub CMBNAME_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles CMBNAME.Validating
        Try
            'If CMBNAME.Text.Trim <> "" Then namevalidate(CMBNAME, CMBACCCODE, e, Me, TXTOTHERCHGSADD, " AND GROUPMASTER.GROUP_SECONDARY = 'SUNDRY DEBTORS'", "SUNDRY DEBTORS")
            If CMBNAME.Text.Trim <> "" Then namevalidate(CMBNAME, CMBACCCODE, e, Me, TXTOTHERCHGSADD, " AND (GROUP_SECONDARY = 'SUNDRY DEBTORS' OR GROUP_SECONDARY = 'SUNDRY CREDITORS')", "SUNDRY DEBTORS")
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Sub FILLHSNITEMDESC(ByRef CMBHSNITEMDESC As ComboBox)
        Try
            Dim objclscommon As New ClsCommon
            Dim dt As DataTable

            dt = objclscommon.search(" ISNULL(HSN_ITEMDESC, '') AS HSNITEMDESC ", "", " HSNMASTER ", " AND HSN_YEARID = " & YearId)
            If dt.Rows.Count > 0 Then
                dt.DefaultView.Sort = "HSNITEMDESC"
                CMBHSNITEMDESC.DataSource = dt
                CMBHSNITEMDESC.DisplayMember = "HSNITEMDESC"
            End If
            CMBHSNITEMDESC.SelectAll()
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub CMBHSNITEMDESC_Enter(ByVal sender As Object, ByVal e As System.EventArgs) Handles CMBHSNITEMDESC.Enter
        Try
            If CMBHSNITEMDESC.Text.Trim = "" Then FILLHSNITEMDESC(CMBHSNITEMDESC)
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub CREDITNOTE_Load(ByVal sender As Object, ByVal e As System.EventArgs) Handles MyBase.Load
        Try

            Dim DTROW() As DataRow = USERRIGHTS.Select("FormName = 'CREDIT NOTE'")
            USERADD = DTROW(0).Item(1)
            USEREDIT = DTROW(0).Item(2)
            USERVIEW = DTROW(0).Item(3)
            USERDELETE = DTROW(0).Item(4)

            FILLCMB()
            clear()

            If BILLNO <> "" Then
                TXTBILLNO.Text = BILLNO
                TXTBILLNO.Enabled = False
                GETDATA()
            End If


            If edit = True Then

                If USEREDIT = False And USERVIEW = False Then
                    MsgBox("Insufficient Rights")
                    Exit Sub
                End If

                Dim dt As New DataTable
                Dim objclsCN As New ClsCreditNote()
                dt = objclsCN.selectCREDITNOTE_edit(TEMPCNNO, TEMPREGNAME, CmpId, Locationid, YearId)

                If dt.Rows.Count > 0 Then
                    For Each dr As DataRow In dt.Rows


                        TXTCNNO.Text = TEMPCNNO
                        cmbregister.Text = TEMPREGNAME
                        TYPE = dt.Rows(0).Item("TYPE")
                        CMBHSNITEMDESC.Text = dt.Rows(0).Item("ITEMDESC")
                        TXTSTATECODE.Text = dt.Rows(0).Item("STATECODE")
                        CNDATE.Value = Convert.ToDateTime(dr("CNDATE")).Date
                        ARRIVALDATE.Value = Convert.ToDateTime(dr("ARRIVALDATE")).Date
                        TXTBILLNO.Text = dt.Rows(0).Item("BILLNO")
                        TXTBILLNO.Enabled = False

                        If TXTBILLNO.Text.Trim = "" Then CMBNAME.Enabled = True Else CMBNAME.Enabled = False

                        TXTGUESTNAME.Text = dt.Rows(0).Item("GUESTNAME")
                        TXTHOTELNAME.Text = dt.Rows(0).Item("HOTELNAME")
                        CMBNAME.Text = dt.Rows(0).Item("NAME")
                        TXTHSNCODE.Text = dt.Rows(0).Item("HSNCODE")

                        TXTTOTALSALEAMT.Text = dt.Rows(0).Item("PURAMT")
                        TXTDISCPER.Text = dt.Rows(0).Item("DISCPER")
                        TXTDISCRS.Text = dt.Rows(0).Item("DISCRS")
                        'TXTCOMMRECDPER.Text = dt.Rows(0).Item("COMMPER")
                        'TXTCOMMRECDRS.Text = dt.Rows(0).Item("COMMRS")
                        'TXTPURTDSPER.Text = dt.Rows(0).Item("TDSPER")
                        'TXTPURTDSRS.Text = dt.Rows(0).Item("TDSRS")
                        TXTEXTRACHGS.Text = dt.Rows(0).Item("EXTRACHGS")
                        TXTSERVCHGS.Text = Val(dt.Rows(0).Item("SERVCHGS"))
                        CHKTAXSERVCHGS.Checked = Convert.ToBoolean(dt.Rows(0).Item("TAXSERVCHGS"))
                        cmbtax.Text = dt.Rows(0).Item("TAXNAME")
                        txttax.Text = dt.Rows(0).Item("TAXAMT")
                        'CMBADDTAX.Text = dt.Rows(0).Item("ADDTAXNAME")
                        'TXTADDTAX.Text = dt.Rows(0).Item("ADDTAXAMT")
                        CMBOTHERCHGS.Text = dt.Rows(0).Item("OTHERCHGSNAME")
                        txtotherchg.Text = dt.Rows(0).Item("OTHERCHGSAMT")

                        If dr("OTHERCHGSAMT") > 0 Then
                            txtotherchg.Text = dr("OTHERCHGSAMT")
                            cmbaddsub.Text = "Add"
                        Else
                            txtotherchg.Text = dr("OTHERCHGSAMT") * (-1)
                            cmbaddsub.Text = "Sub."
                        End If

                        If Convert.ToBoolean(dr("NOGSTR1")) = False Then CHKNOGSTR1.Checked = False Else CHKNOGSTR1.Checked = True
                        If Convert.ToBoolean(dr("MANUALGST")) = False Then CHKMANUAL.Checked = False Else CHKMANUAL.Checked = True

                        If CHKMANUAL.Checked = True Then
                            TXTCGSTAMT.Text = Format(Val(dr("CGSTAMT")), "0.00")
                            TXTSGSTAMT.Text = Format(Val(dr("SGSTAMT")), "0.00")
                            TXTIGSTAMT.Text = Format(Val(dr("IGSTAMT")), "0.00")
                        End If

                        TXTCGSTPER.Text = dr("CGSTPER")
                        TXTCGSTAMT.Text = dr("CGSTAMT")
                        TXTSGSTPER.Text = dr("SGSTPER")
                        TXTSGSTAMT.Text = dr("SGSTAMT")
                        TXTIGSTPER.Text = dr("IGSTPER")
                        TXTIGSTAMT.Text = dr("IGSTAMT")

                        txtroundoff.Text = dt.Rows(0).Item("ROUNDOFF")
                        txtgrandtotal.Text = dt.Rows(0).Item("GTOTAL")
                        txtremarks.Text = Convert.ToString(dr("REMARKS"))
                        TXTDP.Text = Convert.ToString(Val(dr("DP")))

                        TOTAL()
                        TXTIRNNO.Text = dr("IRNNO")
                        TXTACKNO.Text = dr("ACKNO")
                        ACKDATE.Value = dr("ACKDATE")
                        If IsDBNull(dr("QRCODE")) = False Then
                            PBQRCODE.Image = Image.FromStream(New IO.MemoryStream(DirectCast(dr("QRCODE"), Byte())))
                        Else
                            PBQRCODE.Image = Nothing
                        End If
                    Next
                    cmbregister.Enabled = False
                    TXTGUESTNAME.Focus()

                End If
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub toolnext_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles toolnext.Click
        Try
LINE1:
            TEMPCNNO = Val(TXTCNNO.Text) + 1
            TEMPREGNAME = cmbregister.Text.Trim
            getmaxno_CN()
            Dim MAXNO As Integer = TXTCNNO.Text.Trim
            clear()
            If Val(TXTCNNO.Text) - 1 >= TEMPCNNO Then
                edit = True
                CREDITNOTE_Load(sender, e)
            Else
                clear()
                edit = False
            End If
            If CMBNAME.Text.Trim = "" And TEMPCNNO < MAXNO Then
                TXTCNNO.Text = TEMPCNNO
                GoTo LINE1
            End If
        Catch ex As Exception
            If ErrHandle(ex.Message.GetHashCode) = False Then Throw ex
        End Try
    End Sub

    Private Sub toolprevious_Click(ByVal sender As Object, ByVal e As System.EventArgs) Handles toolprevious.Click
        Try
LINE1:
            TEMPCNNO = Val(TXTCNNO.Text) - 1
            TEMPREGNAME = cmbregister.Text.Trim
            If TEMPCNNO > 0 Then
                edit = True
                CREDITNOTE_Load(sender, e)
            Else
                clear()
                edit = False
            End If
            If CMBNAME.Text.Trim = "" And TEMPCNNO > 1 Then
                TXTCNNO.Text = TEMPCNNO
                GoTo LINE1
            End If
        Catch ex As Exception
            If ErrHandle(ex.Message.GetHashCode) = False Then Throw ex
        End Try
    End Sub

    Private Sub ToolStripdelete_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles ToolStripdelete.Click
        Try
            If edit = True Then
                If USERDELETE = False Then
                    MsgBox("Insufficient Rights")
                    Exit Sub
                End If

                Dim tempmsg As Integer = MsgBox("Delete Credit Note Permanently?", MsgBoxStyle.YesNo, "TRAVELMATE")
                If tempmsg = vbYes Then

                    Dim OBJCN As New ClsCreditNote
                    Dim ALPARAVAL As New ArrayList

                    ALPARAVAL.Add(TYPE)
                    ALPARAVAL.Add(TEMPCNNO)
                    ALPARAVAL.Add(TEMPREGNAME)
                    ALPARAVAL.Add(CmpId)
                    ALPARAVAL.Add(Locationid)
                    ALPARAVAL.Add(YearId)
                    ALPARAVAL.Add(Userid)

                    OBJCN.alParaval = ALPARAVAL
                    Dim DT As DataTable = OBJCN.Delete()
                    MsgBox(DT.Rows(0).Item(0).ToString)

                    clear()

                End If

            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub tstxtbillno_Validating(ByVal sender As System.Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles tstxtbillno.Validating
        Try
            If tstxtbillno.Text.Trim.Length = 0 Then Exit Sub
            TEMPCNNO = Val(tstxtbillno.Text)
            TEMPREGNAME = cmbregister.Text.Trim
            If TEMPCNNO > 0 Then
                edit = True
                CREDITNOTE_Load(sender, e)
            Else
                clear()
                edit = False
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub TXTBILLNO_Validating(ByVal sender As Object, ByVal e As System.ComponentModel.CancelEventArgs) Handles TXTBILLNO.Validating
        Try
            If TXTBILLNO.Text.Trim <> "" And edit = False Then
                GETDATA()
                If Val(txtgrandtotal.Text.Trim) = 0 Then
                    MsgBox("Invalid Voucher No")
                    e.Cancel = True
                    Exit Sub
                End If
                TXTBILLNO.Enabled = False
            Else
                TXTBILLNO.Enabled = True
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Sub GETDATA()
        Try
            Dim OBJCMN As New ClsCommon
            'Dim DT As DataTable = OBJCMN.search(" * ", "", " (SELECT HOTELBOOKINGMASTER.BOOKING_SALEAMTREC AS RECDAMT, HOTELBOOKINGMASTER.BOOKING_NO AS BILL, HOTELBOOKINGMASTER.BOOKING_SALEBILLINITIALS AS BILLNO, HOTELBOOKINGMASTER.BOOKING_CMPID AS CMPID, HOTELBOOKINGMASTER.BOOKING_LOCATIONID AS LOCATIONID, HOTELBOOKINGMASTER.BOOKING_YEARID AS YEARID, ISNULL(GUESTMASTER.GUEST_NAME, '') AS GUESTNAME, ISNULL(HOTELMASTER.HOTEL_NAME, '') AS HOTELNAME, ISNULL(LEDGERS.Acc_cmpname, '') AS NAME, HOTELBOOKINGMASTER.BOOKING_TOTALSALEAMT AS SALEAMT, HOTELBOOKINGMASTER.BOOKING_DISCPER AS DISCPER, HOTELBOOKINGMASTER.BOOKING_DISCRS AS DISCRS, HOTELBOOKINGMASTER.BOOKING_EXTRACHGS AS EXTRACHGS, ISNULL(TAXMASTER.tax_name, '') AS TAXNAME, HOTELBOOKINGMASTER.BOOKING_TAX AS TAXAMT, ISNULL(ADDTAXMASTER.tax_name, '') AS ADDTAXNAME, HOTELBOOKINGMASTER.BOOKING_ADDTAX AS ADDTAXAMT, ISNULL(OTHERCHGS.Acc_cmpname, '') AS OTHERCHGSNAME, HOTELBOOKINGMASTER.BOOKING_OTHERCHGS AS OTHERCHGS, HOTELBOOKINGMASTER.BOOKING_ROUNDOFF AS ROUNDOFF, HOTELBOOKINGMASTER.BOOKING_GRANDTOTAL AS GTOTAL FROM LEDGERS RIGHT OUTER JOIN TAXMASTER RIGHT OUTER JOIN GUESTMASTER INNER JOIN HOTELBOOKINGMASTER ON GUESTMASTER.GUEST_ID = HOTELBOOKINGMASTER.BOOKING_GUESTID AND GUESTMASTER.GUEST_CMPID = HOTELBOOKINGMASTER.BOOKING_CMPID AND GUESTMASTER.GUEST_LOCATIONID = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND GUESTMASTER.GUEST_YEARID = HOTELBOOKINGMASTER.BOOKING_YEARID INNER JOIN HOTELMASTER ON HOTELBOOKINGMASTER.BOOKING_HOTELID = HOTELMASTER.HOTEL_ID AND HOTELBOOKINGMASTER.BOOKING_CMPID = HOTELMASTER.HOTEL_CMPID AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = HOTELMASTER.HOTEL_LOCATIONID AND HOTELBOOKINGMASTER.BOOKING_YEARID = HOTELMASTER.HOTEL_YEARID ON TAXMASTER.tax_id = HOTELBOOKINGMASTER.BOOKING_TAXID AND TAXMASTER.tax_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND TAXMASTER.tax_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND TAXMASTER.tax_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID LEFT OUTER JOIN LEDGERS AS OTHERCHGS ON HOTELBOOKINGMASTER.BOOKING_OTHERCHGSID = OTHERCHGS.Acc_id AND HOTELBOOKINGMASTER.BOOKING_YEARID = OTHERCHGS.Acc_yearid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = OTHERCHGS.Acc_locationid AND HOTELBOOKINGMASTER.BOOKING_CMPID = OTHERCHGS.Acc_cmpid LEFT OUTER JOIN TAXMASTER AS ADDTAXMASTER ON HOTELBOOKINGMASTER.BOOKING_ADDTAXID = ADDTAXMASTER.tax_id AND HOTELBOOKINGMASTER.BOOKING_CMPID = ADDTAXMASTER.tax_cmpid AND HOTELBOOKINGMASTER.BOOKING_LOCATIONID = ADDTAXMASTER.tax_locationid AND HOTELBOOKINGMASTER.BOOKING_YEARID = ADDTAXMASTER.tax_yearid ON LEDGERS.Acc_cmpid = HOTELBOOKINGMASTER.BOOKING_CMPID AND LEDGERS.Acc_locationid = HOTELBOOKINGMASTER.BOOKING_LOCATIONID AND LEDGERS.Acc_yearid = HOTELBOOKINGMASTER.BOOKING_YEARID AND LEDGERS.Acc_id = HOTELBOOKINGMASTER.BOOKING_LEDGERID) as T ", " AND T.BILLNO = '" & TXTBILLNO.Text.Trim & "' AND T.CMPID = " & CmpId & " AND T.LOCATIONID = " & Locationid & " AND T.YEARID = " & YearId)
            Dim DT As DataTable = OBJCMN.search(" RESERVATIONDETAILS.RECPAYAMT AS RECDAMT, BOOKINGNO AS BILL, BILLINITIALS AS BILLNO, CMPID, LOCATIONID, YEARID ,GUESTNAME , HOTELNAME ,LEDGERNAME AS NAME, TOTALAMT AS SALEAMT, 0 AS DISCPER, DISCRS , EXTRACHGS, TAXNAME, TAX AS TAXAMT, ADDTAXNAME , ADDTAX AS ADDTAXAMT, OTHERCHGSNAME , OTHERCHGS , ROUNDOFF, GTOTAL, ARRIVAL, TYPE, DP, ISNULL(SERVCHGS,0) AS SERVCHGS, ISNULL(TAXSERVCHGS,0) AS TAXSERVCHGS,ISNULL(HSNCODE, '') AS HSNCODE, ISNULL(HSNDESC, '') AS ITEMDESC, ISNULL(IGSTAMT, 0) AS IGSTAMT, ISNULL(IGSTPER, 0) AS IGSTPER, ISNULL(SGSTAMT, 0) AS SGSTAMT,  ISNULL(SGSTPER, 0) AS SGSTPER, ISNULL(CGSTAMT, 0) AS CGSTAMT, ISNULL(CGSTPER, 0) AS CGSTPER ,MANUALGST ", "", " RESERVATIONDETAILS ", " AND BILLINITIALS = '" & TXTBILLNO.Text.Trim & "' AND YEARID = " & YearId)
            If DT.Rows.Count > 0 Then

                'OLD CODE
                'NEW CODE DONE BY GULKIT, THIS WAS DONE COZ WE HAVE NOW CHANGED ON SERVCHGS FORMAT IN ALL MODULES
                'SO FOR THAT WE HAVE REMOVED EXTRACHGS AND ADDED IN SERVCHGS
                'If DT.Rows(0).Item("TYPE") <> "RAILBOOKING" And DT.Rows(0).Item("TYPE") <> "VISABOOKING" And DT.Rows(0).Item("TYPE") <> "MISCELLANEOUSSALE" Then
                '    LBLEXTRACHGS.Text = "Other Chgs (Add)"
                '    LBLHOTELNAME.Text = "Hotel Name"
                'Else
                '    LBLEXTRACHGS.Text = "Service Chgs (Add)"
                '    LBLHOTELNAME.Text = "Train Name"
                'End If
                If DT.Rows(0).Item("TYPE") = "RAILBOOKING" Then LBLHOTELNAME.Text = "Train Name"


                If DT.Rows(0).Item("RECDAMT") > 0 Then
                    MsgBox("Receipt Made, Delete Receipt First", MsgBoxStyle.Critical)
                    Exit Sub
                End If

                BILLNO = DT.Rows(0).Item("BILL")
                TYPE = DT.Rows(0).Item("TYPE")
                CMBHSNITEMDESC.Text = DT.Rows(0).Item("ITEMDESC")
                ARRIVALDATE.Value = Format(Convert.ToDateTime(DT.Rows(0).Item("ARRIVAL")).Date, "dd/MM/yyyy")

                TXTGUESTNAME.Text = DT.Rows(0).Item("GUESTNAME")
                TXTHOTELNAME.Text = DT.Rows(0).Item("HOTELNAME")
                CMBNAME.Text = DT.Rows(0).Item("NAME")
                GETSTATECODE()
                TXTHSNCODE.Text = DT.Rows(0).Item("HSNCODE")
                TXTTOTALSALEAMT.Text = DT.Rows(0).Item("SALEAMT")
                TXTDISCPER.Text = 0
                TXTDISCRS.Text = DT.Rows(0).Item("DISCRS")
                TXTEXTRACHGS.Text = DT.Rows(0).Item("EXTRACHGS")
                TXTSERVCHGS.Text = DT.Rows(0).Item("SERVCHGS")
                CHKTAXSERVCHGS.Checked = Convert.ToBoolean(DT.Rows(0).Item("TAXSERVCHGS"))
                CHKMANUAL.Checked = Convert.ToBoolean(DT.Rows(0).Item("MANUALGST"))

                cmbtax.Text = DT.Rows(0).Item("TAXNAME")
                txttax.Text = DT.Rows(0).Item("TAXAMT")
                CMBOTHERCHGS.Text = DT.Rows(0).Item("OTHERCHGSNAME")
                If Val(DT.Rows(0).Item("OTHERCHGS")) > 0 Then
                    cmbaddsub.Text = "Add"
                    txtotherchg.Text = DT.Rows(0).Item("OTHERCHGS")
                Else
                    cmbaddsub.Text = "Sub."
                    txtotherchg.Text = DT.Rows(0).Item("OTHERCHGS") * (-1)
                End If

                TXTCGSTPER.Text = DT.Rows(0).Item("CGSTPER")
                TXTCGSTAMT.Text = DT.Rows(0).Item("CGSTAMT")
                TXTSGSTPER.Text = DT.Rows(0).Item("SGSTPER")
                TXTSGSTAMT.Text = DT.Rows(0).Item("SGSTAMT")
                TXTIGSTPER.Text = DT.Rows(0).Item("IGSTPER")
                TXTIGSTAMT.Text = DT.Rows(0).Item("IGSTAMT")

                txtroundoff.Text = DT.Rows(0).Item("ROUNDOFF")
                txtgrandtotal.Text = DT.Rows(0).Item("GTOTAL")
                txtremarks.Text = DT.Rows(0).Item("BILLNO")
                TXTDP.Text = DT.Rows(0).Item("DP")
                TOTAL()

                CMBNAME.Enabled = False

            End If


        Catch ex As Exception
            Throw ex
        End Try

    End Sub

    Private Sub TXTTOTALSALEAMT_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles TXTTOTALSALEAMT.KeyPress, TXTDISCPER.KeyPress, TXTDISCRS.KeyPress, TXTEXTRACHGS.KeyPress, TXTSERVCHGS.KeyPress, txtotherchg.KeyPress
        numdotkeypress(e, sender, Me)
    End Sub

    Private Sub TXTTOTALSALEAMT_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles TXTTOTALSALEAMT.Validated, TXTSERVCHGS.Validated, TXTEXTRACHGS.Validated, TXTDISCRS.Validated, TXTDISCPER.Validated
        TOTAL()
    End Sub

    Private Sub cmbtax_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles cmbtax.Validated
        Try
            If cmbtax.Text.Trim <> "" Then
                Dim OBJCMN As New ClsCommon
                Dim DT As DataTable = OBJCMN.search(" TAX_TAX AS TAX ", "", " TAXMASTER ", " AND TAX_NAME = '" & cmbtax.Text.Trim & "' AND TAX_CMPID = " & CmpId & " AND TAX_LOCATIONID = " & Locationid & " AND TAX_YEARID  =  " & YearId)
                If DT.Rows.Count > 0 Then
                    If Val(DT.Rows(0).Item("TAX")) = 0 Then
                        txttax.ReadOnly = False
                        txttax.Enabled = True
                    End If
                End If
            End If
            TOTAL()
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub txtotherchg_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles txtotherchg.Validated
        TOTAL()
    End Sub

    Private Sub PBDISCDEL_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PBDISCDEL.Click
        Try
            TXTDISCPER.Text = 0.0
            TXTDISCRS.Text = 0.0
            TOTAL()
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub CREDITNOTE_Shown(ByVal sender As Object, ByVal e As System.EventArgs) Handles Me.Shown
        'If ClientName = "TOPCOMM" Then Me.Close()
        If ALLOWEINVOICE = True Then TOOLEINV.Visible = True
        If ClientName = "GLOBAL" Then
            CHKMANUAL.Visible = False
            LBLCGST.Visible = False
            TXTCGSTPER.Visible = False
            TXTCGSTAMT.Visible = False
            LBLSGST.Visible = False
            TXTSGSTPER.Visible = False
            TXTSGSTAMT.Visible = False
            LBLIGST.Visible = False
            TXTIGSTPER.Visible = False
            TXTIGSTAMT.Visible = False
            TXTIGSTAMT.Visible = False
            LBLHSNDESC.Visible = False
            CMBHSNITEMDESC.Visible = False
            LBLHSNCODE.Visible = False
            TXTHSNCODE.Visible = False
            LBLSTATECODE.Visible = False
            TXTSTATECODE.Visible = False

        End If
    End Sub

    Private Sub PrintToolStripButton_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles PrintToolStripButton.Click
        Try
            If edit = True Then PRINTREPORT(TEMPCNNO)
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Sub PRINTREPORT(ByVal BILLNO As Integer)
        Try
            Dim TEMPMSG As Integer = MsgBox("Wish to Print Credit Note?", MsgBoxStyle.YesNo)
            If TEMPMSG = vbYes Then
                Dim OBJCN As New CrDrNoteDesign
                OBJCN.BILLNO = BILLNO
                OBJCN.REGNAME = cmbregister.Text.Trim
                OBJCN.MdiParent = MDIMain
                OBJCN.FRMSTRING = "CREDIT"
                OBJCN.Show()
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub txttax_Validated(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles txttax.Validated
        TOTAL()
    End Sub

    Sub GETHSNCODE()
        Try
            TXTHSNCODE.Clear()
            TXTCGSTPER.Clear()
            TXTCGSTAMT.Clear()
            TXTSGSTPER.Clear()
            TXTSGSTAMT.Clear()
            TXTIGSTPER.Clear()
            TXTIGSTAMT.Clear()

            If CMBHSNITEMDESC.Text.Trim <> "" And Convert.ToDateTime(CNDATE.Text).Date >= "01/07/2017" Then
                Dim OBJCMN As New ClsCommon
                Dim DT As DataTable = OBJCMN.search("  ISNULL(HSN_CODE, '') AS HSNCODE, ISNULL(HSN_CGST, 0) AS CGSTPER, ISNULL(HSN_SGST, 0) AS SGSTPER, ISNULL(HSN_IGST, 0) AS IGSTPER ", "", " HSNMASTER ", " AND HSNMASTER.HSN_ITEMDESC = '" & CMBHSNITEMDESC.Text.Trim & "' AND HSNMASTER.HSN_YEARID='" & YearId & "' ORDER BY HSNMASTER.HSN_ID DESC")
                If DT.Rows.Count > 0 Then
                    TXTHSNCODE.Text = DT.Rows(0).Item("HSNCODE")
                    If CMBNAME.Text.Trim <> "" Then
                        If TXTSTATECODE.Text.Trim = CMPSTATECODE Then
                            TXTIGSTPER.Text = 0
                            TXTCGSTPER.Text = Val(DT.Rows(0).Item("CGSTPER"))
                            TXTSGSTPER.Text = Val(DT.Rows(0).Item("SGSTPER"))
                        Else
                            TXTCGSTPER.Text = 0
                            TXTSGSTPER.Text = 0
                            TXTIGSTPER.Text = Val(DT.Rows(0).Item("IGSTPER"))
                        End If
                    End If
                End If
                TOTAL()

            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub CMBHSNITEMDESC_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles CMBHSNITEMDESC.Validated
        Try

            TXTHSNCODE.Clear()
            TXTCGSTPER.Clear()
            TXTCGSTAMT.Clear()
            TXTSGSTPER.Clear()
            TXTSGSTAMT.Clear()
            TXTIGSTPER.Clear()
            TXTIGSTAMT.Clear()

            If CMBHSNITEMDESC.Text.Trim <> "" And Convert.ToDateTime(CNDATE.Text).Date >= "01/07/2017" Then
                Dim OBJCMN As New ClsCommon
                Dim DT As DataTable = OBJCMN.search("  ISNULL(HSN_CODE, '') AS HSNCODE, ISNULL(HSN_CGST, 0) AS CGSTPER, ISNULL(HSN_SGST, 0) AS SGSTPER, ISNULL(HSN_IGST, 0) AS IGSTPER", "", " HSNMASTER ", " AND HSNMASTER.HSN_ITEMDESC = '" & CMBHSNITEMDESC.Text.Trim & "' AND HSNMASTER.HSN_YEARID='" & YearId & "' ORDER BY HSNMASTER.HSN_ID DESC")
                If DT.Rows.Count > 0 Then
                    TXTHSNCODE.Text = DT.Rows(0).Item("HSNCODE")
                    If CMBNAME.Text.Trim <> "" Then
                        If TXTSTATECODE.Text.Trim = CMPSTATECODE Then
                            TXTIGSTPER.Text = 0
                            TXTCGSTPER.Text = Val(DT.Rows(0).Item("CGSTPER"))
                            TXTSGSTPER.Text = Val(DT.Rows(0).Item("SGSTPER"))
                        Else
                            TXTCGSTPER.Text = 0
                            TXTSGSTPER.Text = 0
                            TXTIGSTPER.Text = Val(DT.Rows(0).Item("IGSTPER"))
                        End If
                    End If

                    '    If CMBPURNAME.Text.Trim <> "" Then
                    '        If TXTPURSTATECODE.Text.Trim = CMPSTATECODE Then
                    '            TXTPURIGSTPER.Text = 0
                    '            TXTPURCGSTPER.Text = Val(DT.Rows(0).Item("PURCGSTPER"))
                    '            TXTPURSGSTPER.Text = Val(DT.Rows(0).Item("PURSGSTPER"))
                    '        Else
                    '            TXTPURCGSTPER.Text = 0
                    '            TXTPURSGSTPER.Text = 0
                    '            TXTPURIGSTPER.Text = Val(DT.Rows(0).Item("PURIGSTPER"))
                    '        End If
                    '    End If
                End If
                TOTAL()
            End If

        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub CMDUPLOADIRN_Click(sender As Object, e As EventArgs) Handles CMDUPLOADIRN.Click
        If (edit = True And USEREDIT = False And USERVIEW = False) Or (edit = False And USERADD = False) Then
            MsgBox("Insufficient Rights")
            Exit Sub
        End If

        OpenFileDialog.Filter = "Pictures (*.png)|*.png"
        OpenFileDialog.ShowDialog()

        OpenFileDialog.AddExtension = True
        TXTFILENAME.Text = OpenFileDialog.SafeFileName
        txtimgpath.Text = OpenFileDialog.FileName
        TXTNEWIMGPATH.Text = Application.StartupPath & "\UPLOADDOCS\" & TXTBILLNO.Text.Trim & TXTCNNO.Text.Trim & TXTFILENAME.Text.Trim
        On Error Resume Next

        If txtimgpath.Text.Trim.Length <> 0 Then
            PBQRCODE.ImageLocation = txtimgpath.Text.Trim
            PBQRCODE.Load(txtimgpath.Text.Trim)
        End If
    End Sub

    Private Async Sub CMDGETQRCODE_Click(sender As Object, e As EventArgs) Handles CMDGETQRCODE.Click
        Try
            If edit = True And TXTIRNNO.Text.Trim <> "" And IsNothing(PBQRCODE.Image) = True Then

                'FIRST GETTOKEN AND THEN GET QRCODE
                Dim OBJCMN As New ClsCommon
                Dim DT As New DataTable

                Dim URL As New Uri("https://einvapi.charteredinfo.com/eivital/dec/v1.04/auth?aspid=1602611918&password=infosys123&Gstin=" & CMPGSTIN & "&user_name=" & CMPEWBUSER & "&eInvPwd=" & CMPEWBPASS)

                ServicePointManager.Expect100Continue = True
                ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12

                Dim REQUEST As WebRequest
                Dim RESPONSE As WebResponse
                REQUEST = WebRequest.CreateDefault(URL)

                REQUEST.Method = "GET"
                Try
                    RESPONSE = REQUEST.GetResponse()
                Catch ex As WebException
                    RESPONSE = ex.Response
                End Try
                Dim READER As StreamReader = New StreamReader(RESPONSE.GetResponseStream())
                Dim REQUESTEDTEXT As String = READER.ReadToEnd()

                'IF STATUS IS NOT 1 THEN TOKEN IS NOT GENERATED
                Dim STARTPOS As Integer = 0
                Dim TEMPSTATUS As String = ""
                Dim TOKEN As String = ""
                Dim ENDPOS As Integer = 0

                STARTPOS = REQUESTEDTEXT.ToLower.IndexOf("status") + Len("STATUS") + 2
                TEMPSTATUS = REQUESTEDTEXT.Substring(STARTPOS, 1)
                If TEMPSTATUS = "1" Then TEMPSTATUS = "SUCCESS" Else TEMPSTATUS = "FAILED"




                STARTPOS = REQUESTEDTEXT.ToLower.IndexOf("authtoken") + Len("AUTHTOKEN") + 3
                ENDPOS = REQUESTEDTEXT.ToLower.IndexOf(",", STARTPOS) - 1
                TOKEN = REQUESTEDTEXT.Substring(STARTPOS, ENDPOS - STARTPOS)

                'ADD DATA IN EINVOICEENTRY
                'DONT ADD IN EINVOICEENTRY, DONE BY GULKIT, IF FAILED THEN ADD
                'DT = OBJCMN.Execute_Any_String("INSERT INTO EINVOICEENTRY VALUES (" & Val(TXTINVOICENO.Text.Trim) & ",'INVOICE','" & TOKEN & "','','" & TEMPSTATUS & "', GETDATE(), " & CmpId & "," & Userid & "," & YearId & ")", "", "")


                'ONCE WE REC THE TOKEN WE WILL CREATE EWAY BILL
                'IF STATUS IS FAILED THEN ERROR MESSAGE
                If TEMPSTATUS = "FAILED" Then
                    MsgBox("Unable to create Eway Bill", MsgBoxStyle.Critical)
                    DT = OBJCMN.Execute_Any_String("INSERT INTO EINVOICEENTRY VALUES (" & Val(TXTCNNO.Text.Trim) & ",'CREDITNOTE','" & TOKEN & "','','" & TEMPSTATUS & "','" & Replace(REQUESTEDTEXT, "'", "''") & "', GETDATE(), " & CmpId & "," & Userid & "," & YearId & ")", "", "")
                    Exit Sub
                End If


                ''GET SIGNED QRCODE
                Dim req As New RestRequest
                req.AddParameter("application/json", "", RestSharp.ParameterType.RequestBody)
                'Dim client As New RestClient("http://gstsandbox.charteredinfo.com/eicore/dec/v1.03/Invoice/irn/" & TXTIRNNO.Text.Trim & "?aspid=1602611918&password=infosys123&gstin=34AACCC1596Q002&user_name=TaxProEnvPON&AuthToken=" & TOKEN & "&QrCodeSize=250")
                Dim client As New RestClient("https://einvapi.charteredinfo.com/eicore/dec/v1.03/Invoice/irn/" & TXTIRNNO.Text.Trim & "?aspid=1602611918&password=infosys123&gstin=" & CMPGSTIN & "&user_name=" & CMPEWBUSER & "&AuthToken=" & TOKEN & "&QrCodeSize=250")
                Dim res As IRestResponse = Await client.ExecuteTaskAsync(req)
                Dim respPl = New RespPl()
                respPl = JsonConvert.DeserializeObject(Of RespPl)(res.Content)
                Dim respPlGenIRNDec As New RespPlGenIRNDec()
                respPlGenIRNDec = JsonConvert.DeserializeObject(Of RespPlGenIRNDec)(respPl.Data)
                'MsgBox(respPlGenIRNDec.Irn)
                Dim qrImg As Byte() = Convert.FromBase64String(respPlGenIRNDec.QrCodeImage)
                Dim tc As TypeConverter = TypeDescriptor.GetConverter(GetType(Bitmap))
                Dim bitmap1 As Bitmap = CType(tc.ConvertFrom(qrImg), Bitmap)



                'bitmap1.Save(Application.StartupPath & "\" & Val(TXTINVOICENO.Text.Trim) & AccFrom.Year & ".png")
                'PBQRCODE.ImageLocation = Application.StartupPath & "\" & Val(TXTINVOICENO.Text.Trim) & AccFrom.Year & ".png"
                'PBQRCODE.Refresh()


                'GET REGINITIALS AS SAVE WITH IT
                Dim TEMPREG As DataTable = OBJCMN.search(" REGISTER_INITIALS AS INITIALS", "", " REGISTERMASTER ", " AND REGISTER_NAME = '" & cmbregister.Text.Trim & "' and register_type = 'CREDITNOTE'  and REGISTER_NAME <> 'AIRLINE CREDITNOTE' AND REGISTER_YEARID = " & YearId)
                bitmap1.Save(Application.StartupPath & "\" & TEMPREG.Rows(0).Item("INITIALS") & Val(TXTCNNO.Text.Trim) & AccFrom.Year & ".png")
                PBQRCODE.ImageLocation = Application.StartupPath & "\" & TEMPREG.Rows(0).Item("INITIALS") & Val(TXTCNNO.Text.Trim) & AccFrom.Year & ".png"
                PBQRCODE.Refresh()



                'If PBQRCODE.Image IsNot Nothing Then
                '    Dim OBJINVOICE As New ClsInvoiceMaster
                '    Dim MS As New IO.MemoryStream
                '    PBQRCODE.Image.Save(MS, Drawing.Imaging.ImageFormat.Png)
                '    OBJINVOICE.alParaval.Add(TXTINVOICENO.Text.Trim)
                '    OBJINVOICE.alParaval.Add(cmbregister.Text.Trim)
                '    OBJINVOICE.alParaval.Add(MS.ToArray)
                '    OBJINVOICE.alParaval.Add(YearId)
                '    Dim INTRES As Integer = OBJINVOICE.SAVEQRCODE()
                'End If

                'DT = OBJCMN.Execute_Any_String("UPDATE INVOICEMASTER SET INVOICE_QRCODE = (SELECT * FROM OPENROWSET(BULK '" & Application.StartupPath & "\" & Val(TXTINVOICENO.Text.Trim) & AccFrom.Year & ".png',SINGLE_BLOB) AS IMG) FROM INVOICEMASTER INNER JOIN REGISTERMASTER ON INVOICE_REGISTERID = REGISTER_ID WHERE INVOICE_NO = " & Val(TXTINVOICENO.Text.Trim) & " AND REGISTER_NAME = '" & cmbregister.Text.Trim & "' AND INVOICE_YEARID = " & YearId, "", "")

                DT = OBJCMN.Execute_Any_String("INSERT INTO EINVOICEENTRY VALUES (" & Val(TXTCNNO.Text.Trim) & ",'CREDITNOTE','" & TOKEN & "','" & TXTIRNNO.Text.Trim & "','QRCODE SUCCESS', '', GETDATE(), " & CmpId & "," & Userid & "," & YearId & ")", "", "")
                DT = OBJCMN.Execute_Any_String("INSERT INTO EINVOICEENTRY VALUES (" & Val(TXTCNNO.Text.Trim) & ",'CREDITNOTE','" & TOKEN & "','" & TXTIRNNO.Text.Trim & "','QRCODE SUCCESS1', '', GETDATE(), " & CmpId & "," & Userid & "," & YearId & ")", "", "")
                cmdok_Click(sender, e)

            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub TOOLEINV_Click(sender As Object, e As EventArgs) Handles TOOLEINV.Click
        Try
            If edit = False Then Exit Sub
            GENERATEINV()
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Async Sub GENERATEINV()
        Try
            If ALLOWEINVOICE = False Then Exit Sub
            If CMBNAME.Text.Trim = "" Then Exit Sub

            If Val(TXTCGSTAMT.Text.Trim) = 0 And Val(TXTSGSTAMT.Text.Trim) = 0 And Val(TXTIGSTAMT.Text.Trim) = 0 Then Exit Sub

            If MsgBox("Generate E-Invoice?", MsgBoxStyle.YesNo) = MsgBoxResult.No Then Exit Sub
            If TXTIRNNO.Text.Trim <> "" Then
                MsgBox("E-Invoice Already Generated", MsgBoxStyle.Critical)
                Exit Sub
            End If

            'BEFORE GENERATING EWAY BILL WE NEED TO VALIDATE WHETHER ALL THE DATA ARE PRESENT OR NOT
            'IF DATA IS NOT PRESENT THEN VALIDATE
            'DATA TO BE CHECKED 
            '   1)CMPEWBUSER | CMPEWBPASS | CMPGSTIN | CMPPINCODE | CMPCITY | CMPSTATE | 
            '   2)PARTYGSTIN | PARTYCITY | PARTYPINCODE | PARTYSTATE | PARTYSTATECODE | PARTYKMS
            '   3)CGST OR SGST OR IGST (ALWAYS USE MTR IN QTYUNIT)
            If CMPEWBUSER = "" Or CMPEWBPASS = "" Or CMPGSTIN = "" Or CMPPINCODE = "" Or CMPCITYNAME = "" Or CMPSTATENAME = "" Then
                MsgBox(" Company Details are not filled properly ", MsgBoxStyle.Critical)
                Exit Sub
            End If

            Dim TEMPCMPADD1 As String = ""
            Dim TEMPCMPADD2 As String = ""
            Dim TEMPCMPDISPATCHADD1 As String = ""
            Dim PARTYGSTIN As String = ""
            Dim PARTYPINCODE As String = ""
            Dim PARTYSTATECODE As String = ""
            Dim PARTYSTATENAME As String = ""
            Dim SHIPTOGSTIN As String = ""
            Dim SHIPTOSTATECODE As String = ""
            Dim SHIPTOSTATENAME As String = ""
            Dim SHIPTOPINCODE As String = ""
            Dim PARTYKMS As Double = 0
            Dim PARTYADD1 As String = ""
            Dim PARTYADD2 As String = ""
            Dim SHIPTOADD1 As String = ""
            Dim SHIPTOADD2 As String = ""
            Dim TRANSGSTIN As String = ""
            'Dim KOTHARIPLACE As String = ""  'THIS VARIABLE IS USED TO FETCH RANGE COLUMN ONLY FOR KOTHARI, THEY WILL ENTER FULL SHIPTO ADDRESS THERE
            Dim DISPATCHFROM As String = ""
            Dim DISPATCHFROMGSTIN As String = ""
            Dim DISPATCHFROMPINCODE As String = ""
            Dim DISPATCHFROMSTATECODE As String = ""
            Dim DISPATCHFROMSTATENAME As String = ""
            Dim DISPATCHFROMKMS As Double = 0
            Dim DISPATCHFROMADD1 As String = ""
            Dim DISPATCHFROMADD2 As String = ""


            Dim OBJCMN As New ClsCommon
            'CMP ADDRESS DETAILS
            Dim DT As DataTable = OBJCMN.search(" ISNULL(CMP_ADD1, '') AS ADD1, ISNULL(CMP_ADD2,'') AS ADD2, ISNULL(CMP_DISPATCHFROM, '') AS DISPATCHADD ", "", " CMPMASTER ", " AND CMP_ID = " & CmpId)
            TEMPCMPADD1 = DT.Rows(0).Item("ADD1")
            TEMPCMPADD2 = DT.Rows(0).Item("ADD2")
            TEMPCMPDISPATCHADD1 = DT.Rows(0).Item("DISPATCHADD")
            DISPATCHFROM = CmpName
            DISPATCHFROMGSTIN = CMPGSTIN
            DISPATCHFROMPINCODE = CMPPINCODE
            DISPATCHFROMSTATECODE = CMPSTATECODE
            DISPATCHFROMSTATENAME = CMPSTATENAME


            'PARTY GST DETAILS 
            DT = OBJCMN.search(" ISNULL(ACC_GSTIN, '') AS GSTIN, ISNULL(ACC_ZIPCODE,'') AS PINCODE, ISNULL(STATE_NAME,'') AS STATENAME, ISNULL(CAST(STATE_REMARK AS VARCHAR(20)),'') AS STATECODE, ISNULL(ACC_ADD1,'') AS ADD1, ISNULL(ACC_ADD2,'') AS ADD2, GROUPMASTER.GROUP_SECONDARY AS SECONDARY  ", "", " LEDGERS LEFT OUTER JOIN STATEMASTER ON ACC_STATEID = STATE_ID INNER JOIN GROUPMASTER ON LEDGERS.ACC_GROUPID = GROUPMASTER.GROUP_ID", " AND ACC_CMPNAME = '" & CMBNAME.Text.Trim & "' AND ACC_YEARID = " & YearId)
            If (DT.Rows(0).Item("GSTIN") = "" Or DT.Rows(0).Item("PINCODE") = "" Or DT.Rows(0).Item("STATENAME") = "" Or DT.Rows(0).Item("STATECODE") = "") Or DT.Rows(0).Item("SECONDARY") <> "Sundry Debtors" Then
                MsgBox(" Party Details are not filled properly ", MsgBoxStyle.Critical)
                Exit Sub
            Else
                PARTYGSTIN = DT.Rows(0).Item("GSTIN")
                SHIPTOGSTIN = DT.Rows(0).Item("GSTIN")
                PARTYSTATENAME = DT.Rows(0).Item("STATENAME")
                PARTYSTATECODE = DT.Rows(0).Item("STATECODE")
                SHIPTOSTATENAME = DT.Rows(0).Item("STATENAME")
                SHIPTOSTATECODE = DT.Rows(0).Item("STATECODE")
                PARTYPINCODE = DT.Rows(0).Item("PINCODE")
                'PARTYKMS = Val(DT.Rows(0).Item("KMS"))
                PARTYADD1 = DT.Rows(0).Item("ADD1")
                PARTYADD2 = DT.Rows(0).Item("ADD2")
            End If


            'CHECKING COUNTER AND VALIDATE WHETHER EINVOICE WILL BE ALLOWED OR NOT, FOR EACH EINVOICE BILL WE NEED TO 2 API COUNTS (1 FOR TOKEN AND ANOTHER FOR EINVOICE)
            If CMPEINVOICECOUNTER = 0 Then
                MsgBox("E-Invoice Bill Package has Expired, Kindly contact Nakoda Infotech on 02249724411", MsgBoxStyle.Critical)
                Exit Sub
            End If

            'GET USED EINVOICECOUNTER
            Dim USEDEINVOICECOUNTER As Integer = 0
            DT = OBJCMN.search("COUNT(COUNTERID) AS EINVOICECOUNT", "", "EINVOICEENTRY", " AND CMPID =" & CmpId)
            If DT.Rows.Count > 0 Then USEDEINVOICECOUNTER = Val(DT.Rows(0).Item("EINVOICECOUNT"))

            'IF COUNTERS ARE FINISJED
            If CMPEINVOICECOUNTER - USEDEINVOICECOUNTER <= 0 Then
                MsgBox("E-Invoice Package has Expired, Kindly contact Nakoda Infotech on 02249724411", MsgBoxStyle.Critical)
                Exit Sub
            End If

            'IF DATE HAS EXPIRED
            If Now.Date > EINVOICEEXPDATE Then
                MsgBox("E-Invoice Package has Expired, Kindly contact Nakoda Infotech on 02249724411", MsgBoxStyle.Critical)
                Exit Sub
            End If

            'IF BALANCECOUNTERS ARE .10 THEN INTIMATE
            If CMPEINVOICECOUNTER - USEDEINVOICECOUNTER < Format((CMPEINVOICECOUNTER * 0.1), "0") Then
                MsgBox("Only " & (CMPEINVOICECOUNTER - USEDEINVOICECOUNTER) & " API's Left, Kindly contact Nakoda Infotech for Renewal of E-Invoice Package", MsgBoxStyle.Critical)
            End If


            'FOR GENERATING EINVOICE BILL WE NEED TO FIRST GENERATE THE TOKEN
            'THIS IS FOR SANDBOX TEST
            'Dim URL As New Uri("http://gstsandbox.charteredinfo.com/eivital/dec/v1.04/auth?aspid=1602611918&password=infosys123&Gstin=34AACCC1596Q002&user_name=TaxProEnvPON&eInvPwd=abc34*")
            Dim URL As New Uri("https://einvapi.charteredinfo.com/eivital/dec/v1.04/auth?aspid=1602611918&password=infosys123&Gstin=" & CMPGSTIN & "&user_name=" & CMPEWBUSER & "&eInvPwd=" & CMPEWBPASS)

            ServicePointManager.Expect100Continue = True
            ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12

            Dim REQUEST As WebRequest
            Dim RESPONSE As WebResponse
            REQUEST = WebRequest.CreateDefault(URL)

            REQUEST.Method = "GET"
            Try
                RESPONSE = REQUEST.GetResponse()
            Catch ex As WebException
                RESPONSE = ex.Response
            End Try
            Dim READER As StreamReader = New StreamReader(RESPONSE.GetResponseStream())
            Dim REQUESTEDTEXT As String = READER.ReadToEnd()

            'IF STATUS IS NOT 1 THEN TOKEN IS NOT GENERATED
            Dim STARTPOS As Integer = 0
            Dim TEMPSTATUS As String = ""
            Dim TOKEN As String = ""
            Dim ENDPOS As Integer = 0

            STARTPOS = REQUESTEDTEXT.ToLower.IndexOf("status") + Len("STATUS") + 2
            TEMPSTATUS = REQUESTEDTEXT.Substring(STARTPOS, 1)
            If TEMPSTATUS = "1" Then TEMPSTATUS = "SUCCESS" Else TEMPSTATUS = "FAILED"




            STARTPOS = REQUESTEDTEXT.ToLower.IndexOf("authtoken") + Len("AUTHTOKEN") + 3
            ENDPOS = REQUESTEDTEXT.ToLower.IndexOf(",", STARTPOS) - 1
            TOKEN = REQUESTEDTEXT.Substring(STARTPOS, ENDPOS - STARTPOS)

            'ADD DATA IN EINVOICEENTRY
            'DONT ADD IN EINVOICEENTRY, DONE BY GULKIT, IF FAILED THEN ADD
            'DT = OBJCMN.Execute_Any_String("INSERT INTO EINVOICEENTRY VALUES (" & Val(TXTINVOICENO.Text.Trim) & ",'INVOICE','" & TOKEN & "','','" & TEMPSTATUS & "', GETDATE(), " & CmpId & "," & Userid & "," & YearId & ")", "", "")


            'ONCE WE REC THE TOKEN WE WILL CREATE EWAY BILL
            'IF STATUS IS FAILED THEN ERROR MESSAGE
            If TEMPSTATUS = "FAILED" Then
                MsgBox("Unable to create E-Invoice", MsgBoxStyle.Critical)
                DT = OBJCMN.Execute_Any_String("INSERT INTO EINVOICEENTRY VALUES (" & Val(TXTCNNO.Text.Trim) & ",'CREDITNOTE','" & TOKEN & "','','" & TEMPSTATUS & "','" & Replace(REQUESTEDTEXT, "'", "''") & "', GETDATE(), " & CmpId & "," & Userid & "," & YearId & ")", "", "")
                Exit Sub
            End If

            Dim j As String = ""
            Dim PRINTINITIALS As String = ""

            'GENERATING EINVOICE
            'FOR SANBOX TEST
            'Dim FURL As New Uri("http://gstsandbox.charteredinfo.com/eicore/dec/v1.03/Invoice?aspid=1602611918&password=infosys123&Gstin=34AACCC1596Q002&AuthToken=" & TOKEN & "&user_name=TaxProEnvPON&QrCodeSize=250")
            Dim FURL As New Uri("https://einvapi.charteredinfo.com/eicore/dec/v1.03/Invoice?aspid=1602611918&password=infosys123&Gstin=" & CMPGSTIN & "&AuthToken=" & TOKEN & "&user_name=" & CMPEWBUSER & "&QrCodeSize=250")
            REQUEST = WebRequest.CreateDefault(FURL)
            REQUEST.Method = "POST"
            Try
                REQUEST.ContentType = "application/json"



                j = "{"
                j = j & """Version"": ""1.1"","
                j = j & """TranDtls"": {"
                j = j & """TaxSch"":""GST"","
                j = j & """SupTyp"":""B2B"","
                j = j & """RegRev"":""N"","
                j = j & """IgstOnIntra"":""N""},"



                'WE NEED TO FETCH INITIALS INSTEAD OF BILLNO
                Dim DTINI As DataTable = OBJCMN.search("CN_INITIALS AS PRINTINITIALS", "", " CREDITNOTEMASTER ", " AND CN_NO = " & Val(TXTCNNO.Text.Trim) & " AND CN_YEARID = " & YearId)
                PRINTINITIALS = DTINI.Rows(0).Item("PRINTINITIALS")

                j = j & """DocDtls"": {"
                j = j & """Typ"":""CRN"","
                j = j & """No"":""" & DTINI.Rows(0).Item("PRINTINITIALS") & """" & ","
                j = j & """Dt"":""" & CNDATE.Text & """" & "},"


                'For WORKING ON SANDBOX
                'CMPGSTIN = "34AACCC1596Q002"
                'CMPPINCODE = "605001"
                'CMPSTATECODE = "34"


                j = j & """SellerDtls"": {"
                j = j & """Gstin"":""" & CMPGSTIN & """" & ","
                j = j & """LglNm"":""" & CmpName & """" & ","
                j = j & """TrdNm"":""" & CmpName & """" & ","
                j = j & """Addr1"":""" & TEMPCMPADD1.Trim.Replace(vbCrLf, " ") & """" & ","
                j = j & """Addr2"":""" & TEMPCMPADD2.Trim.Replace(vbCrLf, " ") & """" & ","
                j = j & """Loc"":""" & CMPCITYNAME & """" & "," 'CMBFROMCITY.Text.Trim & """" & ","
                j = j & """Pin"":" & CMPPINCODE & "" & ","
                j = j & """Stcd"":""" & CMPSTATECODE & """" & "},"

                If PARTYADD1 = "" Then PARTYADD1 = PARTYSTATENAME
                If PARTYADD2 = "" Then PARTYADD2 = PARTYSTATENAME

                j = j & """BuyerDtls"": {"
                j = j & """Gstin"":""" & PARTYGSTIN & """" & ","
                j = j & """LglNm"":""" & CMBNAME.Text.Trim & """" & ","
                j = j & """TrdNm"":""" & CMBNAME.Text.Trim & """" & ","
                j = j & """Pos"":""" & PARTYSTATECODE & """" & ","
                j = j & """Addr1"":""" & PARTYADD1.Replace(vbCrLf, " ") & """" & ","
                j = j & """Addr2"":""" & PARTYADD2.Replace(vbCrLf, " ") & """" & ","
                j = j & """Loc"":""" & PARTYSTATENAME & """" & ","
                j = j & """Pin"":" & PARTYPINCODE & "" & ","
                j = j & """Stcd"":""" & PARTYSTATECODE & """" & "},"


                j = j & """DispDtls"": {"
                j = j & """Nm"":""" & DISPATCHFROM & """" & ","
                j = j & """Addr1"":""" & TEMPCMPDISPATCHADD1.Trim.Replace(vbCrLf, " ") & """" & ","
                j = j & """Addr2"":""" & TEMPCMPADD2.Trim.Replace(vbCrLf, " ") & """" & ","
                j = j & """Loc"":""" & CMPCITYNAME & """" & ","
                j = j & """Pin"":" & DISPATCHFROMPINCODE & "" & ","
                j = j & """Stcd"":""" & DISPATCHFROMSTATECODE & """" & "},"

                j = j & """ShipDtls"": {"
                If SHIPTOGSTIN <> "" Then j = j & """Gstin"":""" & SHIPTOGSTIN & """" & ","
                j = j & """LglNm"":""" & CMBNAME.Text.Trim & """" & ","
                j = j & """TrdNm"":""" & CMBNAME.Text.Trim & """" & ","
                If SHIPTOADD1 = "" Then j = j & """Addr1"":""" & PARTYADD1.Replace(vbCrLf, " ") & """" & "," Else j = j & """Addr1"":""" & SHIPTOADD1.Replace(vbCrLf, " ") & """" & ","
                If SHIPTOADD2 = "" Then SHIPTOADD2 = " ADDRESS2 "
                j = j & """Addr2"":""" & SHIPTOADD2 & """" & ","
                j = j & """Loc"":""" & PARTYSTATENAME & """" & ","
                If SHIPTOPINCODE = "" Then j = j & """Pin"":" & PARTYPINCODE & "" & "," Else j = j & """Pin"":" & SHIPTOPINCODE & "" & ","
                j = j & """Stcd"":""" & SHIPTOSTATECODE & """" & "},"

                Dim TEMPOTHERAMT As Double = 0.0
                Dim TEMPTOTALITEMAMT As Double = 0.0
                If CHKTAXSERVCHGS.Checked = True Then
                    TEMPOTHERAMT = Val(TXTTOTALSALEAMT.Text.Trim) - Val(TXTDISCRS.Text.Trim) + Val(TXTEXTRACHGS.Text.Trim) + Val(txttax.Text.Trim) + Val(txtotherchg.Text.Trim)
                    TEMPTOTALITEMAMT = Val(TXTSERVCHGS.Text.Trim) + Val(TXTCGSTAMT.Text.Trim) + Val(TXTSGSTAMT.Text.Trim) + Val(TXTIGSTAMT.Text.Trim)
                Else
                    TEMPOTHERAMT = Val(txttax.Text.Trim) + Val(txtotherchg.Text.Trim)
                    TEMPTOTALITEMAMT = Val(TXTSUBTOTAL.Text.Trim) + Val(TXTCGSTAMT.Text.Trim) + Val(TXTSGSTAMT.Text.Trim) + Val(TXTIGSTAMT.Text.Trim)
                End If


                j = j & """ItemList"":[{"
                j = j & """SlNo"": """ & "1" & """" & ","
                'j = j & """PrdDesc"":""" & "Travel Booking" & """" & ","
                j = j & """IsServc"":""" & "Y" & """" & ","
                j = j & """HsnCd"":""" & TXTHSNCODE.Text.Trim & """" & ","
                'j = j & """Barcde"":""REC9999"","
                'j = j & """Qty"":" & Val(DTROW("PCS")) & "" & "," Else j = j & """Qty"":" & Val(DTROW("MTRS")) & "" & ","
                'j = j & """FreeQty"":" & "0" & "" & ","
                'j = j & """Unit"":""" & "MTR" & """" & ","
                If CHKTAXSERVCHGS.Checked = True Then j = j & """UnitPrice"":" & Val(TXTSERVCHGS.Text.Trim) & "" & "," Else j = j & """UnitPrice"":" & Val(TXTSUBTOTAL.Text.Trim) & "" & ","
                If CHKTAXSERVCHGS.Checked = True Then j = j & """TotAmt"":" & Format(Val(TXTSERVCHGS.Text.Trim), "0.00") & "" & "," Else j = j & """TotAmt"":" & Format(Val(TXTSUBTOTAL.Text.Trim), "0.00") & "" & ","

                'j = j & """Discount"":" & Format(Val(TEMPLINECHARGES), "0.00") & "" & ","
                'j = j & """PreTaxVal"":" & "1" & "" & ","
                If CHKTAXSERVCHGS.Checked = True Then j = j & """AssAmt"":" & Format(Val(TXTSERVCHGS.Text.Trim), "0.00") & "" & "," Else j = j & """AssAmt"":" & Format(Val(TXTSUBTOTAL.Text.Trim), "0.00") & "" & ","
                Dim DTHSN As DataTable = OBJCMN.search(" ISNULL(HSNMASTER.HSN_CODE, '') AS HSNCODE, ISNULL(HSNMASTER.HSN_CGST, 0) AS CGSTPER, ISNULL(HSNMASTER.HSN_SGST, 0) AS SGSTPER, ISNULL(HSNMASTER.HSN_IGST, 0) AS IGSTPER ", "", "HSNMASTER ", " AND HSNMASTER.HSN_CODE = '" & TXTHSNCODE.Text.Trim & "' AND HSNMASTER.HSN_YEARID=" & YearId)
                j = j & """GstRt"":" & Val(DTHSN.Rows(0).Item("IGSTPER")) & "" & ","


                j = j & """IgstAmt"":" & Val(TXTIGSTAMT.Text.Trim) & "" & ","
                j = j & """CgstAmt"":" & Val(TXTCGSTAMT.Text.Trim) & "" & ","
                j = j & """SgstAmt"":" & Val(TXTSGSTAMT.Text.Trim) & "" & ","
                j = j & """CesRt"":" & "0" & "" & ","
                j = j & """CesAmt"":" & "0" & "" & ","
                j = j & """CesNonAdvlAmt"":" & "0" & "" & ","
                j = j & """StateCesRt"":" & "0" & "" & ","
                j = j & """StateCesAmt"":" & "0" & "" & ","
                j = j & """StateCesNonAdvlAmt"":" & "0" & "" & ","
                j = j & """OthChrg"":" & "0" & "" & ","

                j = j & """TotItemVal"":" & Val(TEMPTOTALITEMAMT) & "" & ","
                j = j & """OrdLineRef"":"" "","
                j = j & """OrgCntry"":""IN"","
                j = j & """PrdSlNo"":""123"","

                j = j & """BchDtls"": {"
                j = j & """Nm"":""123"","
                j = j & """Expdt"":""" & CNDATE.Text & """" & ","
                j = j & """wrDt"":""" & CNDATE.Text & """" & "},"

                j = j & """AttribDtls"": [{"
                j = j & """Nm"":""123"","
                j = j & """Val"":""" & Val(TEMPTOTALITEMAMT) & """" & "}]"

                j = j & " }"

                j = j & " ],"



                j = j & """ValDtls"": {"
                If CHKTAXSERVCHGS.Checked = True Then j = j & """AssVal"":" & Val(TXTSERVCHGS.Text.Trim) & "" & "," Else j = j & """AssVal"":" & Val(TXTSUBTOTAL.Text.Trim) & "" & ","
                j = j & """CgstVal"":" & Val(TXTCGSTAMT.Text.Trim) & "" & ","
                j = j & """SgstVal"":" & Val(TXTSGSTAMT.Text.Trim) & "" & ","
                j = j & """IgstVal"":" & Val(TXTIGSTAMT.Text.Trim) & "" & ","

                j = j & """CesVal"":" & "0" & "" & ","
                j = j & """StCesVal"":" & "0" & "" & ","
                j = j & """Discount"":" & "0" & "" & ","
                j = j & """OthChrg"":" & Val(TEMPOTHERAMT) & "" & ","
                j = j & """RndOffAmt"":" & Val(txtroundoff.Text.Trim) & "" & ","
                j = j & """TotInvVal"":" & Val(txtgrandtotal.Text.Trim) & "" & ","
                j = j & """TotInvValFc"":" & "0" & "" & "},"


                j = j & """PayDtls"": {"
                j = j & """Nm"":"" "","
                j = j & """Accdet"":"" "","
                j = j & """Mode"":""Credit"","
                j = j & """Fininsbr"":"" "","
                j = j & """Payterm"":"" "","
                j = j & """Payinstr"":"" "","
                j = j & """Crtrn"":"" "","
                j = j & """Dirdr"":"" "","
                j = j & """Crday"":" & "0" & "" & ","
                j = j & """Paidamt"":" & "0" & "" & ","
                j = j & """Paymtdue"":" & Val(txtgrandtotal.Text.Trim) & "" & "},"


                j = j & """RefDtls"": {"
                j = j & """InvRm"":""TEST"","
                j = j & """DocPerdDtls"": {"
                j = j & """InvStDt"":""" & CNDATE.Text & """" & ","
                j = j & """InvEndDt"":""" & CNDATE.Text & """" & "},"

                j = j & """PrecDocDtls"": [{"
                j = j & """InvNo"":""" & DTINI.Rows(0).Item("PRINTINITIALS") & """" & ","
                j = j & """InvDt"":""" & CNDATE.Text & """" & ","
                j = j & """OthRefNo"":"" ""}],"

                j = j & """ContrDtls"": [{"
                j = j & """RecAdvRefr"":"" "","
                j = j & """RecAdvDt"":""" & CNDATE.Text & """" & ","
                j = j & """Tendrefr"":"" "","
                j = j & """Contrrefr"":"" "","
                j = j & """Extrefr"":"" "","
                j = j & """Projrefr"":"" "","
                j = j & """Porefr"":"" "","
                j = j & """PoRefDt"":""" & CNDATE.Text & """" & "}]"
                j = j & "},"




                j = j & """AddlDocDtls"": [{"
                j = j & """Url"":""https://einv-apisandbox.nic.in"","
                j = j & """Docs"":""INVOICE"","
                j = j & """Info"":""INVOICE""}],"

                j = j & """TransDocNo"":"" "","



                j = j & """ExpDtls"": {"
                j = j & """ShipBNo"":"" "","
                j = j & """ShipBDt"":""" & CNDATE.Text & """" & ","
                j = j & """Port"":""INBOM1"","
                j = j & """RefClm"":""N"","
                j = j & """ForCur"":""AED"","
                j = j & """CntCode"":""AE""}"



                'THIS CODE IS WRITTEN COZ WHEN BILLTO AND SHIPTO ARE IN THE SAME PINCODE THEN WE HAVE TO PASS MINIMUM 10 KMS
                'OR ELSE IT WILL GIVE ERROR
                If DISPATCHFROMPINCODE = PARTYPINCODE Then PARTYKMS = 10

                'WE HAVE REMOVED CREATING EWAY DIRECTLY FORM EINVOICE
                'USER HAVE TO MANUALLY CREATE EWAY SEPERATELY
                'If TXTVEHICLENO.Text.Trim <> "" Then
                '    j = j & ","
                '    j = j & """EwbDtls"": {"
                '    j = j & """TransId"":""" & TRANSGSTIN & """" & ","
                '    j = j & """TransName"":""" & cmbtrans.Text.Trim & """" & ","
                '    j = j & """Distance"":""" & PARTYKMS & """" & ","
                '    If LRDATE.Text <> "__/__/____" Then j = j & """TransDocDt"":""" & LRDATE.Text & """" & "," Else j = j & """TransDocDt"":"""","
                '    j = j & """VehNo"":""" & TXTVEHICLENO.Text.Trim & """" & ","
                '    j = j & """VehType"":""" & "R" & """" & ","
                '    j = j & """TransMode"":""1""" & "}"
                'End If

                j = j & "}"


                Dim stream As Stream = REQUEST.GetRequestStream()
                Dim buffer As Byte() = System.Text.Encoding.UTF8.GetBytes(j)
                stream.Write(buffer, 0, buffer.Length)

                'POST request absenden
                RESPONSE = REQUEST.GetResponse()



            Catch ex As WebException
                'RESPONSE = ex.Response
                'MsgBox("Error While Generating EWB, Please check the Data Properly")
                ''ADD DATA IN EINVOICEENTRY
                'DT = OBJCMN.Execute_Any_String("INSERT INTO EINVOICEENTRY VALUES (" & Val(TXTINVOICENO.Text.Trim) & ",'INVOICE','" & TOKEN & "','','FAILED', GETDATE(), " & CmpId & "," & Userid & "," & YearId & ")", "", "")

                RESPONSE = ex.Response
                READER = New StreamReader(RESPONSE.GetResponseStream())
                REQUESTEDTEXT = READER.ReadToEnd()
                GoTo ERRORMESSAGE
            End Try

            READER = New StreamReader(RESPONSE.GetResponseStream())
            REQUESTEDTEXT = READER.ReadToEnd()


            STARTPOS = REQUESTEDTEXT.ToLower.IndexOf("status") + Len("STATUS") + 3
            TEMPSTATUS = REQUESTEDTEXT.Substring(STARTPOS, 1)
            If TEMPSTATUS = "1" Then
                TEMPSTATUS = "SUCCESS"
                MsgBox("E-Invoice Generated Successfully ")

            Else

ERRORMESSAGE:
                TEMPSTATUS = "FAILED"

                'Dim ERRORMSG As String = ""
                'STARTPOS = REQUESTEDTEXT.ToLower.IndexOf("ErrorMessage") + Len("ErrorMessage") + 5
                'ENDPOS = REQUESTEDTEXT.ToLower.IndexOf("""", STARTPOS) - 2
                'ERRORMSG = REQUESTEDTEXT.Substring(STARTPOS, ENDPOS - STARTPOS)

                'ADD DATA IN EINVOICEENTRY
                DT = OBJCMN.Execute_Any_String("INSERT INTO EINVOICEENTRY VALUES (" & Val(TXTCNNO.Text.Trim) & ",'CREDITNOTE','" & TOKEN & "','','FAILED','" & Replace(REQUESTEDTEXT, "'", "''") & "', GETDATE(), " & CmpId & "," & Userid & "," & YearId & ")", "", "")

                MsgBox("Error While Generating E-Invoice, " & REQUESTEDTEXT)

                Exit Sub
            End If


            Dim IRNNO As String = ""
            Dim ACKNO As String = ""
            Dim ADATE As String = ""


            STARTPOS = REQUESTEDTEXT.ToLower.IndexOf("ackno") + Len("ACKNO") + 5
            ENDPOS = REQUESTEDTEXT.ToLower.IndexOf("\", STARTPOS)
            ACKNO = REQUESTEDTEXT.Substring(STARTPOS, ENDPOS - STARTPOS)
            TXTACKNO.Text = ACKNO


            STARTPOS = REQUESTEDTEXT.ToLower.IndexOf("ackdt") + Len("ACKDT") + 5
            ENDPOS = REQUESTEDTEXT.ToLower.IndexOf("\", STARTPOS)
            ADATE = REQUESTEDTEXT.Substring(STARTPOS, ENDPOS - STARTPOS)
            ACKDATE.Value = ADATE

            STARTPOS = REQUESTEDTEXT.ToLower.IndexOf("irn") + Len("IRN") + 5
            ENDPOS = REQUESTEDTEXT.ToLower.IndexOf("\", STARTPOS)
            IRNNO = REQUESTEDTEXT.Substring(STARTPOS, ENDPOS - STARTPOS)
            TXTIRNNO.Text = IRNNO


            'WE NEED TO UPDATE THIS IRNNO IN DATABASE ALSO
            DT = OBJCMN.Execute_Any_String("UPDATE CREDITNOTEMASTER SET CN_IRNNO = '" & TXTIRNNO.Text.Trim & "', CN_ACKNO = '" & TXTACKNO.Text.Trim & "', CN_ACKDATE = '" & Format(ACKDATE.Value.Date, "MM/dd/yyyy") & "' FROM CREDITNOTEMASTER WHERE CN_NO = " & Val(TXTCNNO.Text.Trim) & " AND CN_YEARID = " & YearId, "", "")

            'ADD DATA IN EINVOICEENTRY
            DT = OBJCMN.Execute_Any_String("INSERT INTO EINVOICEENTRY VALUES (" & Val(TXTCNNO.Text.Trim) & ",'CREDITNOTE','" & TOKEN & "','" & IRNNO & "','" & TEMPSTATUS & "', '', GETDATE(), " & CmpId & "," & Userid & "," & YearId & ")", "", "")


            'ADD DATA IN EINVOICEENTRY FOR QRCODE
            If TEMPSTATUS = "SUCCESS" Then

                ''GET SIGNED QRCODE
                Dim req As New RestRequest
                req.AddParameter("application/json", j, RestSharp.ParameterType.RequestBody)
                'Dim client As New RestClient("http://gstsandbox.charteredinfo.com/eicore/dec/v1.03/Invoice/irn/" & TXTIRNNO.Text.Trim & "?aspid=1602611918&password=infosys123&gstin=34AACCC1596Q002&user_name=TaxProEnvPON&AuthToken=" & TOKEN & "&QrCodeSize=250")
                Dim client As New RestClient("https://einvapi.charteredinfo.com/eicore/dec/v1.03/Invoice/irn/" & TXTIRNNO.Text.Trim & "?aspid=1602611918&password=infosys123&gstin=" & CMPGSTIN & "&user_name=" & CMPEWBUSER & "&AuthToken=" & TOKEN & "&QrCodeSize=250")
                Dim res As IRestResponse = Await client.ExecuteTaskAsync(req)
                Dim respPl = New RespPl()
                respPl = JsonConvert.DeserializeObject(Of RespPl)(res.Content)
                Dim respPlGenIRNDec As New RespPlGenIRNDec()
                respPlGenIRNDec = JsonConvert.DeserializeObject(Of RespPlGenIRNDec)(respPl.Data)
                'MsgBox(respPlGenIRNDec.Irn)
                Dim qrImg As Byte() = Convert.FromBase64String(respPlGenIRNDec.QrCodeImage)
                Dim tc As TypeConverter = TypeDescriptor.GetConverter(GetType(Bitmap))
                Dim bitmap1 As Bitmap = CType(tc.ConvertFrom(qrImg), Bitmap)

                'GET REGINITIALS AS SAVE WITH IT
                Dim TEMPREG As DataTable = OBJCMN.search(" REGISTER_INITIALS AS INITIALS", "", " REGISTERMASTER ", " AND REGISTER_NAME = '" & cmbregister.Text.Trim & "' and register_type = 'CREDITNOTE'  and REGISTER_NAME <> 'AIRLINE CREDITNOTE' AND REGISTER_YEARID = " & YearId)
                bitmap1.Save(Application.StartupPath & "\" & TEMPREG.Rows(0).Item("INITIALS") & Val(TXTCNNO.Text.Trim) & AccFrom.Year & ".png")
                PBQRCODE.ImageLocation = Application.StartupPath & "\" & TEMPREG.Rows(0).Item("INITIALS") & Val(TXTCNNO.Text.Trim) & AccFrom.Year & ".png"
                PBQRCODE.Refresh()

                If PBQRCODE.Image IsNot Nothing Then
                    Dim OBJINVOICE As New ClsCreditNote
                    Dim MS As New IO.MemoryStream
                    PBQRCODE.Image.Save(MS, Drawing.Imaging.ImageFormat.Png)
                    OBJINVOICE.alParaval.Add(TXTCNNO.Text.Trim)
                    OBJINVOICE.alParaval.Add(MS.ToArray)
                    OBJINVOICE.alParaval.Add(YearId)
                    Dim INTRES As Integer = OBJINVOICE.SAVEQRCODE()
                End If

                'DT = OBJCMN.Execute_Any_String("UPDATE INVOICEMASTER SET INVOICE_QRCODE = (SELECT * FROM OPENROWSET(BULK '" & Application.StartupPath & "\" & Val(TXTINVOICENO.Text.Trim) & AccFrom.Year & ".png',SINGLE_BLOB) AS IMG) FROM INVOICEMASTER INNER JOIN REGISTERMASTER ON INVOICE_REGISTERID = REGISTER_ID WHERE INVOICE_NO = " & Val(TXTINVOICENO.Text.Trim) & " AND REGISTER_NAME = '" & cmbregister.Text.Trim & "' AND INVOICE_YEARID = " & YearId, "", "")


                DT = OBJCMN.Execute_Any_String("INSERT INTO EINVOICEENTRY VALUES (" & Val(TXTCNNO.Text.Trim) & ",'CREDITNOTE','" & TOKEN & "','" & IRNNO & "','QRCODE SUCCESS', '', GETDATE(), " & CmpId & "," & Userid & "," & YearId & ")", "", "")
                DT = OBJCMN.Execute_Any_String("INSERT INTO EINVOICEENTRY VALUES (" & Val(TXTCNNO.Text.Trim) & ",'CREDITNOTE','" & TOKEN & "','" & IRNNO & "','QRCODE SUCCESS1', '', GETDATE(), " & CmpId & "," & Userid & "," & YearId & ")", "", "")

            End If




            'STARTPOS = REQUESTEDTEXT.ToLower.IndexOf("QrCodeImage\", 0) + Len("QrCodeImage\") + 5
            'ENDPOS = REQUESTEDTEXT.ToLower.IndexOf("""", STARTPOS)
            ''Dim QRSTREAM As New MemoryStream
            ''Dim bmp As New Bitmap(QRSTREAM)
            ''bmp.Save(QRSTREAM, Drawing.Imaging.ImageFormat.Bmp)
            ''QRSTREAM.Position = STARTPOS
            ''Dim data As Byte()
            ''QRSTREAM.Read(data, STARTPOS, STARTPOS - ENDPOS)

            'Dim bytes() As Byte
            'Dim ImageInStringFormat As String = REQUESTEDTEXT.Substring(STARTPOS, ENDPOS - STARTPOS)
            'Dim MS As System.IO.MemoryStream
            'Dim NewImage As Bitmap

            'Dim nbyte() As Byte = System.Text.Encoding.UTF8.GetBytes(ImageInStringFormat)
            'Dim BASE64STRING As String = Convert.ToBase64String(nbyte)

            'bytes = Convert.FromBase64String(BASE64STRING)
            'NewImage = BytesToBitmap(bytes)
            'MS = New System.IO.MemoryStream(bytes)
            'MS.Write(bytes, 0, bytes.Length)
            'NewImage.Save(MS, Drawing.Imaging.ImageFormat.Bmp)    ' = System.Drawing.Image.FromStream(MS, True)
            'NewImage.Save("d:\qrcode.jpg", System.Drawing.Imaging.ImageFormat.Jpeg)

            'IRNNO = REQUESTEDTEXT.Substring(STARTPOS, ENDPOS - STARTPOS)

            ''ADD data IN EINVOICEENTRY
            'DT = OBJCMN.Execute_Any_String("INSERT INTO EINVOICEENTRY VALUES (" & Val(TXTINVOICENO.Text.Trim) & ",'INVOICE','" & TOKEN & "','" & IRNNO & "','" & TEMPSTATUS & "', '', GETDATE(), " & CmpId & "," & Userid & "," & YearId & ")", "", "")



        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub CHKTAXSERVCHGS_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles CHKTAXSERVCHGS.CheckedChanged
        TOTAL()
    End Sub

    Private Sub CHKMANUAL_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles CHKMANUAL.CheckedChanged
        Try
            If CHKMANUAL.Checked = True Then
                TXTCGSTAMT.ReadOnly = False
                TXTCGSTAMT.TabStop = True
                TXTCGSTAMT.BackColor = Color.LemonChiffon
                TXTSGSTAMT.ReadOnly = False
                TXTSGSTAMT.TabStop = True
                TXTSGSTAMT.BackColor = Color.LemonChiffon
                TXTIGSTAMT.ReadOnly = False
                TXTIGSTAMT.TabStop = True
                TXTIGSTAMT.BackColor = Color.LemonChiffon
            Else
                TXTCGSTAMT.ReadOnly = True
                TXTCGSTAMT.TabStop = False
                TXTCGSTAMT.BackColor = Color.Linen
                TXTSGSTAMT.ReadOnly = True
                TXTSGSTAMT.TabStop = False
                TXTSGSTAMT.BackColor = Color.Linen
                TXTIGSTAMT.ReadOnly = True
                TXTIGSTAMT.TabStop = False
                TXTIGSTAMT.BackColor = Color.Linen
                TOTAL()
            End If
        Catch ex As Exception
            Throw ex
        End Try
    End Sub

    Private Sub TXTCGSTAMT_KeyPress(ByVal sender As Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles TXTCGSTAMT.KeyPress, TXTSGSTAMT.KeyPress, TXTIGSTAMT.KeyPress
        numdotkeypress(e, sender, Me)
    End Sub

    Private Sub TXTCGSTAMT_Validated(ByVal sender As Object, ByVal e As System.EventArgs) Handles TXTCGSTAMT.Validated, TXTSGSTAMT.Validated, TXTIGSTAMT.Validated
        TOTAL()
    End Sub

End Class